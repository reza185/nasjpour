<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TPM">
    <title>TMP</title>
    <link rel="icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="../../manifest.json">
    <link rel="apple-touch-icon" href="../../icons/icon-192x192.png">
    <link rel="apple-touch-startup-image" href="../../icons/icon-512x512.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- <script src="../../auth.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            * {
    -webkit-tap-highlight-color: transparent;  /* Ø¯Ø§Ø´Øª */
    -webkit-text-size-adjust: 100%;           /* Ø¯Ø§Ø´Øª */  
    touch-action: manipulation;               /* Ø¯Ø§Ø´Øª */
}
        }

        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #e74c3c;
            --accent-light: #ff6b6b;
            --secondary: #3498db;
            --dark: #1a252f;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        body {
            background: #f8f9fa;
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            -webkit-overflow-scrolling: touch;
            padding-top: env(safe-area-inset-top, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† */
        .navbar {
            background: var(--primary);
            color: white;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            background: transparent;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link.active {
            background: rgba(255,255,255,0.15);
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .login-time {
            font-size: 11px;
            opacity: 0.8;
            color: #ecf0f1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px;
            width: 100%;
        }

        .header-card {
            background: var(--secondary);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .page-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .login-info i {
            font-size: 11px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
            width: 100%;
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--accent);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            width: 100%;
        }

        .summary-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #eaeaea;
            transition: transform 0.3s ease;
        }

        .summary-item:hover {
            transform: translateY(-2px);
        }

        .summary-number {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--secondary);
        }

        .summary-label {
            color: var(--gray);
            font-size: 12px;
        }

        .report-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #eaeaea;
            transition: transform 0.2s;
        }

        .report-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .report-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .report-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            background: var(--secondary);
            flex-shrink: 0;
        }

        .report-content {
            flex: 1;
        }

        .report-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .report-desc {
            color: var(--gray);
            font-size: 12px;
        }

        .download-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            touch-action: manipulation;
            flex-shrink: 0;
        }

        .download-btn:hover {
            background: var(--accent-light);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #eaeaea;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 500px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: right;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 1px solid #eaeaea;
            font-size: 14px;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eaeaea;
            font-size: 14px;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        .cleanup-alert {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .cleanup-alert-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cleanup-alert-text {
            flex: 1;
        }

        .cleanup-alert-title {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .cleanup-alert-desc {
            opacity: 0.9;
            font-size: 12px;
        }

        .cleanup-alert-actions {
            display: flex;
            gap: 8px;
        }

        .alert-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            touch-action: manipulation;
        }

        .alert-btn-primary {
            background: white;
            color: #e74c3c;
        }

        .alert-btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
            touch-action: manipulation;
        }

        .search-bar {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            min-width: 150px;
            touch-action: manipulation;
        }

        .bg-success { background: var(--success); }
        .bg-warning { background: var(--warning); }
        .bg-danger { background: var(--danger); }
        .bg-info { background: var(--secondary); }
        .bg-primary { background: var(--primary); }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .report-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .nav-links {
                gap: 8px;
            }
            
            .nav-link span {
                display: none;
            }
            
            .user-details {
                display: none;
            }

            .cleanup-alert-content {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .filter-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0 10px;
            }
            
            .nav-container {
                height: 50px;
            }
            
            .logo-icon {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            .header-card {
                padding: 15px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .card {
                padding: 15px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .summary-number {
                font-size: 18px;
            }
            
            .report-icon {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }

        /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… */
        @media (hover: none) and (pointer: coarse) {
            * {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            input, textarea, select {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
        }

        button, .btn {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        @media (max-width: 768px) {
            button:active, .btn:active {
                transform: scale(0.98);
                opacity: 0.9;
            }
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± iOS */
        input, select, textarea {
            font-size: 16px !important;
            transform: translateZ(0);
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ select Ø¯Ø± iOS */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 16px;
            padding-left: 40px;
        }

        /* Ø­Ø¯Ø§Ù‚Ù„ Ø³Ø§ÛŒØ² Ù„Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± iOS */
        button, .btn, .nav-link, .alert-btn, .download-btn {
            min-height: 44px !important;
            min-width: 44px !important;
            cursor: pointer;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¯Ø± iOS */
        .table-container, .container {
            -webkit-overflow-scrolling: touch !important;
            overflow-x: auto;
        }

        /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² highlight Ø¢Ø¨ÛŒ Ø¯Ø± iOS */
        * {
            -webkit-tap-highlight-color: transparent !important;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ tables Ø¯Ø± iOS */
        .data-table {
            -webkit-overflow-scrolling: touch;
        }

        /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² bounce Ø¨ÛŒØ´ Ø§Ø² Ø­Ø¯ Ø¯Ø± iOS */
        body {
            overscroll-behavior-y: none;
            -webkit-overflow-scrolling: touch;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ inputÙ‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø¯Ø± iOS */
        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù…â€ŒÙ‡Ø§ Ø¯Ø± iOS */
        .search-bar, .filter-select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            touch-action: manipulation;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ navigation Ø¯Ø± iOS */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ Ø¯Ø± iOS */
        .report-list, .summary-grid {
            -webkit-overflow-scrolling: touch;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ø¯Ø± iOS */
        .card, .summary-item {
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ Ø¯Ø± iOS */
        i, .fas, .far, .fab {
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ Ø¯Ø± iOS */
        a {
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ Ø¯Ø± iOS */
        .negative {
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø± iOS */
        .download-btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ navigation links Ø¯Ø± iOS */
        .nav-link:active {
            background: rgba(255,255,255,0.2) !important;
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ action items Ø¯Ø± iOS */
        .report-item:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ metric cards Ø¯Ø± iOS */
        .summary-item:active {
            transform: translateY(-2px) scale(0.98);
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú© */
        @media (max-width: 360px) {
            .navbar {
                padding: 0 8px;
            }
            
            .nav-container {
                height: 48px;
            }
            
            .logo-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .logo-text {
                font-size: 12px;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 11px;
            }
            
            .container {
                padding: 10px 8px;
            }
            
            .header-card {
                padding: 12px;
            }
            
            .page-title {
                font-size: 16px;
            }
            
            .page-subtitle {
                font-size: 12px;
            }
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø­Ø§Ù„Øª landscape */
        @media (max-height: 500px) and (orientation: landscape) {
            .navbar {
                height: 48px;
            }
            
            .nav-container {
                height: 48px;
            }
            
            .container {
                padding: 10px 15px;
            }
            
            .header-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
        }

        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø­Ø§Ù„Øª PWA (Ù†ØµØ¨ Ø´Ø¯Ù‡) */
        @media all and (display-mode: standalone) {
            body {
                height: 100vh;
                height: -webkit-fill-available;
                height: fill-available;
            }
            
            .navbar {
                padding-top: env(safe-area-inset-top);
            }
            
            .container {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <!-- Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-icon">
                    <img src="../../Logo.png" style="max-block-size:100% ;" >
                </div>
                <div class="logo-text">TPM PRO</div>
            </div>
            
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </a>
                <a href="reports.html" class="nav-link active">
                    <i class="fas fa-chart-bar"></i>
                    <span>Ú¯Ø²Ø§Ø±Ø´Ø§Øª</span>
                </a>
                <a href="warehouse.html" class="nav-link">
                    <i class="fas fa-warehouse"></i>
                    <span>Ø§Ù†Ø¨Ø§Ø±</span>
                </a>
            </div>
            
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="userName">Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…</div>
                    <div class="login-time" id="loginTime">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
                <div class="user-avatar" id="userAvatar">Ù…Ø¯</div>
            </div>
        </div>
    </nav>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="container">
        <!-- Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ -->
        <div class="cleanup-alert" id="cleanupAlert">
            <div class="cleanup-alert-content">
                <div class="cleanup-alert-text">
                    <div class="cleanup-alert-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    </div>
                    <div class="cleanup-alert-desc" id="cleanupMessage">
                        Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ 1 Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø± Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯.
                    </div>
                </div>
                <div class="cleanup-alert-actions">
                    <button class="alert-btn alert-btn-secondary" onclick="dismissAlert()">
                        Ø¨Ø¹Ø¯Ø§Ù‹ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ú©Ù†
                    </button>
                    <button class="alert-btn alert-btn-primary" onclick="downloadAllData()">
                        <i class="fas fa-download"></i>
                        Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    </button>
                </div>
            </div>
        </div>

        <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
        <div class="header-card">
            <h1 class="page-title">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h1>
            <p class="page-subtitle">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ© Ø¨Ø±Ø§ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª</p>
            <div class="login-info">
                <i class="fas fa-clock"></i>
                Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: <span id="lastLoginTime">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
            </div>
        </div>

        <!-- Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-chart-pie"></i>
                Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ
            </h2>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="totalReports">0</div>
                    <div class="summary-label">Ú©Ù„ Ú¯Ø²Ø§Ø±Ø´Ø§Øª</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-number" id="pendingReports">0</div>
                    <div class="summary-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-number" id="completedReports">0</div>
                    <div class="summary-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-number" id="referredReports">0</div>
                    <div class="summary-label">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ±</div>
                </div>
            </div>
        </div>

        <!-- ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-filter"></i>
                ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ
            </h2>
            
            <div class="filter-row">
                <input type="text" class="search-bar" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´Ø§Øª..." id="searchInput">
                
                <select class="filter-select" id="statusFilter">
                    <option value="all">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ</option>
                    <option value="approved">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</option>
                    <option value="rejected">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                    <option value="in-progress">Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…</option>
                    <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                    <option value="referred_to_manager">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ±</option>
                </select>
                
                <select class="filter-select" id="priorityFilter">
                    <option value="all">Ù‡Ù…Ù‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="low">Ú©Ù…</option>
                    <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                    <option value="high">Ø¨Ø§Ù„Ø§</option>
                    <option value="critical">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                </select>

                <button class="download-btn" onclick="downloadFilteredData()">
                    <i class="fas fa-download"></i>
                    Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡
                </button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-file-alt"></i>
                Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
                <span style="font-size: 12px; color: var(--gray); margin-right: auto;" id="reportsCount">
                    (0 Ú¯Ø²Ø§Ø±Ø´)
                </span>
            </h2>
            
            <div class="report-list" id="reportsList">
                  <!-- Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-chart-bar"></i>
                
            </h2>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ù…Ø¹ÛŒØ§Ø±</th>
                            <th>Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ</th>
                            <th>Ù‡Ø¯Ù</th>
                            <th>Ø§Ù†Ø­Ø±Ø§Ù</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ (Ø³Ø§Ø¹Øª)</td>
                            <td id="avgResponseTime">-</td>
                            <td>4</td>
                            <td class="negative" id="responseDeviation">-</td>
                        </tr>
                        <tr>
                            <td>Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ù…ÙˆÙÙ‚</td>
                            <td id="completionRate">-</td>
                            <td>95%</td>
                            <td class="negative" id="completionDeviation">-</td>
                        </tr>
                        <tr>
                            <td>Ù‡Ø²ÛŒÙ†Ù‡ Ù…ØªÙˆØ³Ø· ØªØ¹Ù…ÛŒØ±Ø§Øª</td>
                            <td id="avgRepairCost">-</td>
                            <td>$1,100</td>
                            <td class="negative" id="costDeviation">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            </div>
        </div>

      
        <div id="offlineAlert" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: #e74c3c; color: white; text-align: center; padding: 10px; z-index: 10003; font-family: Vazirmatn;">
            <i class="fas fa-wifi-slash"></i> Ø­Ø§Ù„Øª Ø¢ÙÙ„Ø§ÛŒÙ† - Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª
        </div>

<!-- Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† -->
<button onclick="testNotificationWithClick()" 
        style="position: fixed; bottom: 20px; right: 20px; z-index: 10000; padding: 12px 20px; background: #2c3e50; color: white; border: none; border-radius: 8px; cursor: pointer;">
    ğŸ”” ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
</button>

<script>
// ØªØ§Ø¨Ø¹ ØªØ³Øª Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±
async function testNotificationWithClick() {
    console.log('ğŸ§ª ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Ø¨Ø±...');
    
    try {
        const result = await NotificationSender.notifyManagers({
            id: 'click-test-' + Date.now(),
            machine_name: 'Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ³Øª',
            problem_description: 'Ø§ÛŒÙ† ØªØ³Øª Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ø³Øª'
        });
        
        if (result) {
            console.log('âœ… ØªØ³Øª Ù…ÙˆÙÙ‚');
            alert('Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!');
        } else {
            console.log('âŒ ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚');
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§:', error);
        alert('Ø®Ø·Ø§: ' + error.message);
    }
}
</script>



    <!-- Ø¯Ú©Ù…Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ -->
<button onclick="requestNotificationPermission()" 
        style="position: fixed; bottom: 80px; right: 20px; z-index: 10000; padding: 12px 20px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer;">
    ğŸ”” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ
</button>

<script>
// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
async function requestNotificationPermission() {
    console.log('ğŸ”” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†...');
    
    try {
        const granted = await NotificationSender.requestPermission();
        if (granted) {
            alert('âœ… Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø¯Ù‡ Ø´Ø¯!');
        } else {
            alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯');
        }
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ:', error);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ');
    }
}
</script>
















    
    <script>
        // ==================== CUSTOM ALERT SYSTEM ====================
        delete window.alert;

        window.alert = function(message) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    padding: 25px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                    text-align: center;
                    min-width: 300px;
                    max-width: 90%;
                    font-family: Vazirmatn, sans-serif;
                    border: 2px solid #2c3e50;
                `;
                
                dialog.innerHTML = `
                    <div style="margin-bottom: 20px; font-size: 16px; color: #2c3e50; line-height: 1.5;">${message}</div>
                    <button onclick="closeCustomAlert()" 
                            style="padding: 10px 25px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        ØªØ£ÛŒÛŒØ¯
                    </button>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                window.closeCustomAlert = function() {
    const overlay = document.querySelector('[style*="z-index: 10000"]');
    if (overlay) {
        document.body.removeChild(overlay);
    }
    resolve();
};
            });
        };

        // ==================== ORIGINAL CODE (ONLY ALERT MODIFIED) ====================
        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
        function formatPersianDateTime(date) {
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Intl.DateTimeFormat('fa-IR', options).format(date);
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡ Ø§Ø² ÙˆØ±ÙˆØ¯
        function getTimeSinceLogin(loginTime) {
            const now = new Date();
            const diff = now - loginTime;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours} Ø³Ø§Ø¹Øª Ùˆ ${minutes % 60} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„`;
            } else {
                return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„`;
            }
        }

        // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
        function updateOnlineTime() {
            const loginTimeElement = document.getElementById('loginTime');
            if (loginTimeElement && window.loginTime) {
                loginTimeElement.textContent = getTimeSinceLogin(window.loginTime);
            }
        }

        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯
        document.addEventListener('DOMContentLoaded', function() {
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø¨Ø§ Ø­Ø±Ú©Ø§Øª Ú†Ù†Ø¯Ù„Ù…Ø³ÛŒ
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);

            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
            });

            document.addEventListener('gestureend', function(e) {
                e.preventDefault();
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
            const now = new Date();
            window.loginTime = now;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯
            const loginTimeElement = document.getElementById('loginTime');
            const lastLoginTimeElement = document.getElementById('lastLoginTime');
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            
            if (loginTimeElement) {
                loginTimeElement.textContent = formatPersianDateTime(now);
            }
            
            if (lastLoginTimeElement) {
                lastLoginTimeElement.textContent = formatPersianDateTime(now);
            }

            // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
            setInterval(updateOnlineTime, 60000);

            // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase Ùˆ Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            loadManagerReports();
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ±
            document.getElementById('searchInput').addEventListener('input', filterReports);
            document.getElementById('statusFilter').addEventListener('change', filterReports);
            document.getElementById('priorityFilter').addEventListener('change', filterReports);
            
            // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„ Ø¯Ø± Ù†ÙˆÛŒÚ¯ÛŒØ´Ù†
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² ØµÙØ­Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            if (typeof auth !== 'undefined') {
                if (auth.protectPageByRole('manager')) {
                    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
                    if (userNameElement) {
                        userNameElement.textContent = auth.getUsername() || 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
                    }
                    if (userAvatarElement) {
                        userAvatarElement.textContent = auth.getUsername() ? auth.getUsername().charAt(0) : 'M';
                    }
                }
            } else {
                // Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡ - ÙˆÙ‚ØªÛŒ auth.js ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                console.log('Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡: ÙØ§ÛŒÙ„ auth.js ÛŒØ§ÙØª Ù†Ø´Ø¯');
                if (userNameElement) {
                    userNameElement.textContent = 'Ù…Ø¯ÛŒØ±  (ØªÙˆØ³Ø¹Ù‡)';
                }
                if (userAvatarElement) {
                    userAvatarElement.textContent = 'M';
                }
            }
        });

        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ù‡Ù†Ú¯Ø§Ù… Ø²ÙˆÙ… Ø¯Ø± iOS
        // document.addEventListener('touchmove', function(e) {
        //     if(e.scale !== 1) {
        //         e.preventDefault();
        //     }
        // }, { passive: false });

        // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase
        const SUPABASE_URL = 'https://kalykylvjqigqlaprlca.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthbHlreWx2anFpZ3FsYXBybGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI1OTcsImV4cCI6MjA3OTEzODU5N30.S8YtogVrxkqYjkgfkGpy4_mS6mqaNxmsHjxnhyBPwEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allReports = [];
        let filteredReports = [];

        // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ',
                'approved': 'ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                'rejected': 'Ø±Ø¯ Ø´Ø¯Ù‡',
                'in-progress': 'Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…',
                'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                'referred_to_manager': 'Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ±'
            };
            return statusMap[status] || status;
        }

        function getPriorityText(priority) {
            const priorityMap = {
                'low': 'Ú©Ù…',
                'medium': 'Ù…ØªÙˆØ³Ø·',
                'high': 'Ø¨Ø§Ù„Ø§',
                'critical': 'Ø¨Ø­Ø±Ø§Ù†ÛŒ'
            };
            return priorityMap[priority] || priority;
        }

        function getPriorityColor(priority) {
            const colorMap = {
                'low': '#2ecc71',
                'medium': '#f39c12', 
                'high': '#e74c3c',
                'critical': '#c0392b'
            };
            return colorMap[priority] || '#3498db';
        }

        // Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø§Ø² Ø¬Ø¯ÙˆÙ„ managerreports
        async function loadManagerReports() {
            try {
                const { data: reports, error } = await supabase
                    .from('managerreports')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
                    // Ø§Ú¯Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                    if (error.code === 'PGRST204') {
                        // await createSampleData();
                        return;
                    }
                    throw error;
                }

                allReports = reports || [];
                filteredReports = [...allReports];
                
                updateStats();
                renderReports();
                checkCleanupAlert();
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:', error);
                await alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø§Ø² Ø³Ø±ÙˆØ±');
            }
        }


        // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
        function updateStats() {
            const totalReports = allReports.length;
            const pendingReports = allReports.filter(r => 
                !r.status || r.status === 'pending' || r.status === 'in-progress'
            ).length;
            const completedReports = allReports.filter(r => r.status === 'completed').length;
            const referredReports = allReports.filter(r => r.status === 'referred_to_manager').length;

            document.getElementById('totalReports').textContent = totalReports;
            document.getElementById('pendingReports').textContent = pendingReports;
            document.getElementById('completedReports').textContent = completedReports;
            document.getElementById('referredReports').textContent = referredReports;
            document.getElementById('reportsCount').textContent = `(${filteredReports.length} Ú¯Ø²Ø§Ø±Ø´)`;

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
            updatePerformanceMetrics();
        }

        // Ø¢Ù¾Ø¯ÛŒØª Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
        function updatePerformanceMetrics() {
            const completedReports = allReports.filter(r => r.status === 'completed');
            
            if (completedReports.length > 0) {
                // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ
                const totalResponseTime = completedReports.reduce((sum, report) => {
                    const createdAt = new Date(report.created_at);
                    const completedAt = new Date(report.completed_at || report.updated_at || report.created_at);
                    const diffHours = (completedAt - createdAt) / (1000 * 60 * 60);
                    return sum + (isNaN(diffHours) ? 0 : diffHours);
                }, 0);
                
                const avgResponseTime = (totalResponseTime / completedReports.length).toFixed(1);
                document.getElementById('avgResponseTime').textContent = `${avgResponseTime} Ø³Ø§Ø¹Øª`;
                document.getElementById('responseDeviation').textContent = `${(avgResponseTime - 4).toFixed(1)} Ø³Ø§Ø¹Øª`;

                // Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ù…ÙˆÙÙ‚
                const successfulCompletions = completedReports.filter(r => 
                    !r.decision_status || r.decision_status === 'approved'
                ).length;
                const completionRate = ((successfulCompletions / completedReports.length) * 100).toFixed(1);
                document.getElementById('completionRate').textContent = `${completionRate}%`;
                document.getElementById('completionDeviation').textContent = `${(completionRate - 95).toFixed(1)}%`;
            } else {
                document.getElementById('avgResponseTime').textContent = '-';
                document.getElementById('responseDeviation').textContent = '-';
                document.getElementById('completionRate').textContent = '-';
                document.getElementById('completionDeviation').textContent = '-';
            }
            
            document.getElementById('avgRepairCost').textContent = '-';
            document.getElementById('costDeviation').textContent = '-';
        }

        // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´Ø§Øª
        function renderReports() {
            const reportsList = document.getElementById('reportsList');
            
            if (!filteredReports || filteredReports.length === 0) {
                reportsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                        <h3>Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                        <p>Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯.</p>
                    </div>
                `;
                return;
            }

            reportsList.innerHTML = filteredReports.map(report => {
                const status = report.status || 'pending';
                const priority = report.priority || 'medium';
                const priorityColor = getPriorityColor(priority);
                
                return `
                <div class="report-item">
                    <div class="report-info">
                        <div class="report-icon" style="background: ${priorityColor}">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="report-content">
                            <div class="report-title">${report.machine_name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
                            <div class="report-desc">${report.problem_description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}</div>
                            <div style="display: flex; gap: 10px; margin-top: 6px; font-size: 11px; color: #666; flex-wrap: wrap;">
                                <span><strong>Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡Ù†Ø¯Ù‡:</strong> ${report.reporter_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span>
                                <span><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${getStatusText(status)}</span>
                                <span><strong>Ø§ÙˆÙ„ÙˆÛŒØª:</strong> ${getPriorityText(priority)}</span>
                                <span><strong>ØªØ§Ø±ÛŒØ®:</strong> ${new Date(report.created_at).toLocaleDateString('fa-IR')}</span>
                            </div>
                            ${report.manager_message ? `
                                <div style="margin-top: 6px; padding: 6px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
                                    <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…Ø¯ÛŒØ±:</strong> ${report.manager_message}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="download-btn" onclick="downloadSingleReport('${report.id}')" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´">
                            <i class="fas fa-download"></i>
                            Ø¯Ø§Ù†Ù„ÙˆØ¯
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ú¯Ø²Ø§Ø±Ø´Ø§Øª
        function filterReports() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;

            filteredReports = allReports.filter(report => {
                const matchesSearch = 
                    (report.machine_name && report.machine_name.toLowerCase().includes(searchTerm)) || 
                    (report.problem_description && report.problem_description.toLowerCase().includes(searchTerm)) ||
                    (report.reporter_name && report.reporter_name.toLowerCase().includes(searchTerm));
                
                const reportStatus = report.status || 'pending';
                const matchesStatus = statusFilter === 'all' || reportStatus === statusFilter;
                
                const reportPriority = report.priority || 'medium';
                const matchesPriority = priorityFilter === 'all' || reportPriority === priorityFilter;
                
                return matchesSearch && matchesStatus && matchesPriority;
            });

            renderReports();
            updateStats();
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
        function checkCleanupAlert() {
            const now = new Date();
            const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
            const daysUntilCleanup = Math.ceil((nextMonth - now) / (1000 * 60 * 60 * 24));
            
            if (daysUntilCleanup <= 1) {
                const alertElement = document.getElementById('cleanupAlert');
                const messageElement = document.getElementById('cleanupMessage');
                
                messageElement.textContent = 
                    `Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ ${daysUntilCleanup} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø± Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯.`;
                
                alertElement.style.display = 'block';
            }
        }

        // Ø¨Ø³ØªÙ† Ù‡Ø´Ø¯Ø§Ø±
        function dismissAlert() {
            document.getElementById('cleanupAlert').style.display = 'none';
        }

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        // ==================== DOWNLOAD SYSTEM ====================

        // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
        function showDownloadOptions(type, reportId = null) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); text-align: center; min-width: 320px; max-width: 90%; font-family: Vazirmatn, sans-serif;">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Ø§Ù†ØªØ®Ø§Ø¨ ÙØ±Ù…Øª Ø¯Ø§Ù†Ù„ÙˆØ¯</h3>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                        <button onclick="downloadSelectedFormat('${type}', '${reportId}', 'csv')" 
                                style="padding: 12px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-width: 100px;">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button onclick="downloadSelectedFormat('${type}', '${reportId}', 'json')" 
                                style="padding: 12px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-width: 100px;">
                            <i class="fas fa-file-code"></i> JSON
                        </button>
                    </div>
                    <button onclick="closeDownloadModal()" 
                            style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                </div>
            `;
            
            modal.id = 'downloadModal';
            document.body.appendChild(modal);
            
            window.closeDownloadModal = function() {
                const modal = document.getElementById('downloadModal');
                if (modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§ ÙØ±Ù…Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
        async function downloadSelectedFormat(type, reportId, format) {
            try {
                let data, filename;
                
                if (type === 'all') {
                    // ØªØ¨Ø¯ÛŒÙ„ Ù‡Ù…Ù‡ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¨Ù‡ ÙØ±Ù…Øª ÙØ§Ø±Ø³ÛŒ
                    data = allReports.map(report => convertToPersianFormat(report));
                    filename = 'Ù‡Ù…Ù‡_Ú¯Ø²Ø§Ø±Ø´Ø§Øª_Ù…Ø¯ÛŒØ±ÛŒØªÛŒ';
                } else if (type === 'filtered') {
                    // ØªØ¨Ø¯ÛŒÙ„ Ú¯Ø²Ø§Ø±Ø´Ø§Øª ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡ Ø¨Ù‡ ÙØ±Ù…Øª ÙØ§Ø±Ø³ÛŒ
                    data = filteredReports.map(report => convertToPersianFormat(report));
                    filename = 'Ú¯Ø²Ø§Ø±Ø´Ø§Øª_ÙÛŒÙ„ØªØ±_Ø´Ø¯Ù‡';
                } else if (type === 'single') {
                    const report = allReports.find(r => r.id === reportId);
                    if (!report) {
                        throw new Error('Ú¯Ø²Ø§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    }
                    // ÙÙ‚Ø· ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ ØªÚ©ÛŒ
                    data = [{
                        'Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡': report.machine_name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                        'ØªÙˆØ¶ÛŒØ­ Ù…Ø´Ú©Ù„': report.problem_description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª',
                        'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡Ù†Ø¯Ù‡': report.reporter_name || 'Ù†Ø§Ù…Ø´Ø®Øµ',
                        'ÙˆØ¶Ø¹ÛŒØª': getStatusText(report.status),
                        'Ø§ÙˆÙ„ÙˆÛŒØª': getPriorityText(report.priority),
                        'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯': new Date(report.created_at).toLocaleDateString('fa-IR'),
                        'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…Ø¯ÛŒØ±': report.manager_message || ''
                    }];
                    filename = `Ú¯Ø²Ø§Ø±Ø´_${report.machine_name || report.id}`;
                } else {
                    throw new Error('Ù†ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
                }
                
                await downloadData(data, filename, format);
                closeDownloadModal();
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯:', error);
                await alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„');
            }
        }

        // ØªØ¨Ø¯ÛŒÙ„ Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡ ÙØ±Ù…Øª ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
        function convertToPersianFormat(report) {
            return {
                'Ù†Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡': report.machine_name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                'ØªÙˆØ¶ÛŒØ­ Ù…Ø´Ú©Ù„': report.problem_description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª',
                'Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡Ù†Ø¯Ù‡': report.reporter_name || 'Ù†Ø§Ù…Ø´Ø®Øµ',
                'ÙˆØ¶Ø¹ÛŒØª': getStatusText(report.status),
                'Ø§ÙˆÙ„ÙˆÛŒØª': getPriorityText(report.priority),
                'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯': new Date(report.created_at).toLocaleDateString('fa-IR'),
                'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…Ø¯ÛŒØ±': report.manager_message || '',
                'Ø´Ù†Ø§Ø³Ù‡': report.id || '',
                'ØªØ§Ø±ÛŒØ® Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ': report.updated_at ? new Date(report.updated_at).toLocaleDateString('fa-IR') : '',
                'ØªØ§Ø±ÛŒØ® ØªÚ©Ù…ÛŒÙ„': report.completed_at ? new Date(report.completed_at).toLocaleDateString('fa-IR') : '',
                'ØªØµÙ…ÛŒÙ… Ù…Ø¯ÛŒØ±': getDecisionText(report.decision_status)
            };
        }

        // ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª ØªØµÙ…ÛŒÙ…
        function getDecisionText(decision) {
            const decisionMap = {
                'approved': 'ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                'rejected': 'Ø±Ø¯ Ø´Ø¯Ù‡',
                'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±'
            };
            return decisionMap[decision] || decision || '';
        }

        // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        async function downloadData(data, filename, format) {
            try {
                if (!data || data.length === 0) {
                    await alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                    return;
                }

                let fileContent, fileExtension, mimeType;

                if (format === 'csv') {
                    fileContent = convertToCSV(data);
                    fileExtension = 'csv';
                    mimeType = 'text/csv;charset=utf-8;';
                } else if (format === 'json') {
                    fileContent = JSON.stringify(data, null, 2);
                    fileExtension = 'json';
                    mimeType = 'application/json';
                } else {
                    throw new Error('ÙØ±Ù…Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±');
                }

                // Ø§ÛŒØ¬Ø§Ø¯ BOM Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Excel
                if (format === 'csv') {
                    const BOM = '\uFEFF';
                    fileContent = BOM + fileContent;
                }

                createDownloadLink(fileContent, `${filename}.${fileExtension}`, mimeType);
                
                await alert(`ÙØ§ÛŒÙ„ ${filename}.${fileExtension} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯`);
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„:', error);
                await alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ÛŒ');
            }
        }

        // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ CSV Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² ÙØ§Ø±Ø³ÛŒ
        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')];
            
            // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            for (const row of data) {
                const values = headers.map(header => {
                    let value = row[header];
                    
                    // Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± null/undefined
                    if (value === null || value === undefined) return '';
                    
                    // Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§
                    if (typeof value === 'string') {
                        // Ø­Ø°Ù Ø®Ø·ÙˆØ· Ø¬Ø¯ÛŒØ¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÙˆØªÛŒØ´Ù†â€ŒÙ‡Ø§
                        value = value.replace(/\n/g, ' ').replace(/\r/g, ' ');
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    
                    return value;
                });
                csvRows.push(values.join(','));
            }
            
            return csvRows.join('\n');
        }

        // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯
        function createDownloadLink(data, filename, mimeType) {
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            
            // ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
        }

        // ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ (Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯)
        async function downloadAllData() {
            showDownloadOptions('all');
        }

        async function downloadFilteredData() {
            showDownloadOptions('filtered');
        }

        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø§ showDownloadOptions Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´Ø¯Ù‡)
        async function downloadSingleReport(reportId) {
            showDownloadOptions('single', reportId);
        }


        // Ø³Ø±ÙˆÛŒØ³ ÙˆØ±Ú©Ø±
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('../sw.js');
            });
        }

        // Ù…Ø¯ÛŒØ±ÛŒØª Ø¢ÙÙ„Ø§ÛŒÙ†
        window.addEventListener('online', function() {
            document.getElementById('offlineAlert').style.display = 'none';
        });

        window.addEventListener('offline', function() {
            document.getElementById('offlineAlert').style.display = 'block';
        });

        if (!navigator.onLine) {
            document.getElementById('offlineAlert').style.display = 'block';
        }













// Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¬Ø¯ÛŒØ¯ Ù…Ø¯ÛŒØ±Ø§Ù†
// Ø§ÛŒÙ† Ù…ØªØºÛŒØ±Ù‡Ø§ Ø±Ùˆ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ØªØ§Ø¨Ø¹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ±
        class ManagerNotificationManager {
            constructor() {
                this.isProcessing = false;
                this.processedIds = new Set();
                this.subscription = null;
                this.lastProcessedTime = 0;
                this.MIN_INTERVAL = 3000; // 3 Ø«Ø§Ù†ÛŒÙ‡
                this.init();
            }

            async init() {
                await this.setupRealtime();
            }

            async setupRealtime() {
                try {
                    // Ù„ØºÙˆ subscription Ù…ÙˆØ¬ÙˆØ¯
                    if (this.subscription) {
                        await supabase.removeChannel(this.subscription);
                    }

                    this.subscription = supabase
                        .channel('manager-reports-channel')
                        .on('postgres_changes', 
                            { 
                                event: 'INSERT', 
                                schema: 'public', 
                                table: 'managerreports'
                            }, 
                            (payload) => this.handleNewReport(payload)
                        )
                        .subscribe((status) => {
                            console.log('ğŸ“¡ ÙˆØ¶Ø¹ÛŒØª Ù…Ø¯ÛŒØ±:', status);
                        });

                    console.log('âœ… Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±Ø§Ù† ÙØ¹Ø§Ù„ Ø´Ø¯');

                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ù…Ø¯ÛŒØ±:', error);
                    setTimeout(() => this.setupRealtime(), 10000);
                }
            }

            async handleNewReport(payload) {
                const now = Date.now();
                
                // Ú†Ú© Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„ Ø²Ù…Ø§Ù†ÛŒ
                if (now - this.lastProcessedTime < this.MIN_INTERVAL) {
                    console.log('â° Ø§ÛŒÙ†ØªØ±ÙˆØ§Ù„ Ø²Ù…Ø§Ù†ÛŒ Ø±Ø¹Ø§ÛŒØª Ù†Ø´Ø¯Ù‡');
                    return;
                }

                // Ú†Ú© Ù‚ÙÙ„ Ù¾Ø±Ø¯Ø§Ø²Ø´
                if (this.isProcessing) {
                    console.log('ğŸ”’ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú¯Ø²Ø§Ø±Ø´ Ù‚Ø¨Ù„ÛŒ...');
                    return;
                }

                // Ú†Ú© ØªÚ©Ø±Ø§Ø±ÛŒ
                const reportId = payload.new.id;
                if (this.processedIds.has(reportId)) {
                    console.log('ğŸ”„ Ú¯Ø²Ø§Ø±Ø´ ØªÚ©Ø±Ø§Ø±ÛŒ:', reportId);
                    return;
                }

                this.isProcessing = true;
                this.lastProcessedTime = now;
                this.processedIds.add(reportId);

                try {
                    console.log('ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø¯ÛŒØ¯ Ù…Ø¯ÛŒØ±:', payload.new);
                    
                    await NotificationSender.notifyManagers({
                        id: reportId,
                        machine_name: payload.new.machine_name,
                        problem_description: payload.new.problem_description
                    });
                    loadManagerReports();


                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹Ù„Ø§Ù† Ù…Ø¯ÛŒØ±:', error);
                } finally {
                    // Ø¢Ø²Ø§Ø¯ Ú©Ø±Ø¯Ù† Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø®ÛŒØ±
                    setTimeout(() => {
                        this.isProcessing = false;
                    }, 1000);

                    // Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡
                    this.cleanupProcessedIds();
                }
            }

            cleanupProcessedIds() {
                if (this.processedIds.size > 100) {
                    const array = Array.from(this.processedIds);
                    // Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† ÙÙ‚Ø· 50 Ø¢ÛŒØªÙ… Ø¢Ø®Ø±
                    this.processedIds = new Set(array.slice(-50));
                }
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ DOM Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯
        document.addEventListener('DOMContentLoaded', function() {
            // Ú©Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ÛŒ...
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
            setTimeout(() => {
                new ManagerNotificationManager();
                console.log('âœ… Ø³ÛŒØ³ØªÙ… Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
            }, 2000);

            // ØªØ³Øª Ø¯Ø³ØªÛŒ - Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ú©Ø±Ø¯ Ø³ÛŒØ³ØªÙ…
            window.testManagerNotification = function() {
                NotificationSender.notifyManagers({
                    id: 'test-' + Date.now(),
                    machine_name: 'Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ³Øª',
                    problem_description: 'Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ø§Ø³Øª'
                });
            };
        });






        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØ§Ø¨Ø¹ ØªØ³Øª Ø¨Ù‡ ØµÙˆØ±Øª global
window.testManagerNotification = function() {
    console.log('ğŸ§ª ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø¯ÛŒØ±...');
    
    if (typeof NotificationSender === 'undefined') {
        console.error('âŒ NotificationSender ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡');
        alert('NotificationSender ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡!');
        return;
    }
    
    NotificationSender.notifyManagers({
        id: 'test-' + Date.now(),
        machine_name: 'Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ³Øª',
        problem_description: 'Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ø§Ø³Øª'
    }).then(success => {
        if (success) {
            console.log('âœ… ØªØ³Øª Ù…ÙˆÙÙ‚');
        } else {
            console.log('âŒ ØªØ³Øª Ù†Ø§Ù…ÙˆÙÙ‚');
        }
    });
};

console.log('âœ… ØªØ§Ø¨Ø¹ testManagerNotification ØªØ¹Ø±ÛŒÙ Ø´Ø¯');
        
    </script>
        <script src="./manager-notifier.js"></script>
<script src="../../notification-sender.js"></script>
    <script src="../../sw.js"></script>
</body>
</html>

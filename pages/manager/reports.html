<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TMP</title>
    <link rel="icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- <script src="../../auth.js"></script> -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #e74c3c;
            --accent-light: #ff6b6b;
            --secondary: #3498db;
            --dark: #1a252f;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        body {
            background: #f8f9fa;
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
        }

        /* Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† */
        .navbar {
            background: var(--primary);
            color: white;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            background: transparent;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 700;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link.active {
            background: rgba(255,255,255,0.15);
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .login-time {
            font-size: 11px;
            opacity: 0.8;
            color: #ecf0f1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px;
            width: 100%;
        }

        .header-card {
            background: var(--secondary);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .page-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .login-info {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .login-info i {
            font-size: 11px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
            width: 100%;
            margin-bottom: 50px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i {
            color: var(--accent);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            width: 100%;
        }

        .summary-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid #eaeaea;
            transition: transform 0.3s ease;
        }

        .summary-item:hover {
            transform: translateY(-2px);
        }

        .summary-number {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--secondary);
        }

        .summary-label {
            color: var(--gray);
            font-size: 12px;
        }

        .report-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .report-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #eaeaea;
            transition: transform 0.2s;
        }

        .report-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .report-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .report-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            background: var(--secondary);
            flex-shrink: 0;
        }

        .report-content {
            flex: 1;
        }

        .report-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .report-desc {
            color: var(--gray);
            font-size: 12px;
        }

        .download-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            touch-action: manipulation;
            flex-shrink: 0;
        }

        .download-btn:hover {
            background: var(--accent-light);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #eaeaea;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 500px;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 10px;
            text-align: right;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 1px solid #eaeaea;
            font-size: 14px;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eaeaea;
            font-size: 14px;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        .cleanup-alert {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: pulse 2s infinite;
        }

        .cleanup-alert-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cleanup-alert-text {
            flex: 1;
        }

        .cleanup-alert-title {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .cleanup-alert-desc {
            opacity: 0.9;
            font-size: 12px;
        }

        .cleanup-alert-actions {
            display: flex;
            gap: 8px;
        }

        .alert-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            touch-action: manipulation;
        }

        .alert-btn-primary {
            background: white;
            color: #e74c3c;
        }

        .alert-btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid white;
        }

        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 13px;
            cursor: pointer;
            min-width: 120px;
            touch-action: manipulation;
        }

        .search-bar {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            min-width: 150px;
            touch-action: manipulation;
        }

        .bg-success { background: var(--success); }
        .bg-warning { background: var(--warning); }
        .bg-danger { background: var(--danger); }
        .bg-info { background: var(--secondary); }
        .bg-primary { background: var(--primary); }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 1024px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .report-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .nav-links {
                gap: 8px;
            }
            
            .nav-link span {
                display: none;
            }
            
            .user-details {
                display: none;
            }

            .cleanup-alert-content {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }

            .filter-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0 10px;
            }
            
            .nav-container {
                height: 50px;
            }
            
            .logo-icon {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .user-avatar {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            .header-card {
                padding: 15px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .card {
                padding: 15px;
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .summary-number {
                font-size: 18px;
            }
            
            .report-icon {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
        }

        /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… */
        @media (hover: none) and (pointer: coarse) {
            * {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            input, textarea, select {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
        }
    </style>
</head>
<body>
    <!-- Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-icon">
                    <img src="../../Logo.png" style="max-block-size:100% ;" >
                </div>
                <div class="logo-text">TPM PRO</div>
            </div>
            
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </a>
                <a href="reports.html" class="nav-link active">
                    <i class="fas fa-chart-bar"></i>
                    <span>Ú¯Ø²Ø§Ø±Ø´Ø§Øª</span>
                </a>
                <a href="warehouse.html" class="nav-link">
                    <i class="fas fa-warehouse"></i>
                    <span>Ø§Ù†Ø¨Ø§Ø±</span>
                </a>
            </div>
            
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="userName">Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…</div>
                    <div class="login-time" id="loginTime">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
                <div class="user-avatar" id="userAvatar">Ù…Ø¯</div>
            </div>
        </div>
    </nav>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="container">
        <!-- Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ -->
        <div class="cleanup-alert" id="cleanupAlert">
            <div class="cleanup-alert-content">
                <div class="cleanup-alert-text">
                    <div class="cleanup-alert-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    </div>
                    <div class="cleanup-alert-desc" id="cleanupMessage">
                        Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ 1 Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø± Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯.
                    </div>
                </div>
                <div class="cleanup-alert-actions">
                    <button class="alert-btn alert-btn-secondary" onclick="dismissAlert()">
                        Ø¨Ø¹Ø¯Ø§Ù‹ ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ú©Ù†
                    </button>
                    <button class="alert-btn alert-btn-primary" onclick="downloadAllData()">
                        <i class="fas fa-download"></i>
                        Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                    </button>
                </div>
            </div>
        </div>

        <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
        <div class="header-card">
            <h1 class="page-title">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h1>
            <p class="page-subtitle">Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒÚ© Ø¨Ø±Ø§ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª</p>
            <div class="login-info">
                <i class="fas fa-clock"></i>
                Ø¢Ø®Ø±ÛŒÙ† ÙˆØ±ÙˆØ¯: <span id="lastLoginTime">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
            </div>
        </div>

        <!-- Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-chart-pie"></i>
                Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ
            </h2>
            
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="totalReports">0</div>
                    <div class="summary-label">Ú©Ù„ Ú¯Ø²Ø§Ø±Ø´Ø§Øª</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-number" id="pendingReports">0</div>
                    <div class="summary-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-number" id="completedReports">0</div>
                    <div class="summary-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
                </div>
                
                <div class="summary-item">
                    <div class="summary-number" id="referredReports">0</div>
                    <div class="summary-label">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ±</div>
                </div>
            </div>
        </div>

        <!-- ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-filter"></i>
                ÙÛŒÙ„ØªØ± Ùˆ Ø¬Ø³ØªØ¬Ùˆ
            </h2>
            
            <div class="filter-row">
                <input type="text" class="search-bar" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´Ø§Øª..." id="searchInput">
                
                <select class="filter-select" id="statusFilter">
                    <option value="all">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ</option>
                    <option value="approved">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</option>
                    <option value="rejected">Ø±Ø¯ Ø´Ø¯Ù‡</option>
                    <option value="in-progress">Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…</option>
                    <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                    <option value="referred_to_manager">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ±</option>
                </select>
                
                <select class="filter-select" id="priorityFilter">
                    <option value="all">Ù‡Ù…Ù‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§</option>
                    <option value="low">Ú©Ù…</option>
                    <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                    <option value="high">Ø¨Ø§Ù„Ø§</option>
                    <option value="critical">Ø¨Ø­Ø±Ø§Ù†ÛŒ</option>
                </select>

                <button class="download-btn" onclick="downloadFilteredData()">
                    <i class="fas fa-download"></i>
                    Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡
                </button>
            </div>
        </div>

        <!-- Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-file-alt"></i>
                Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ
                <span style="font-size: 12px; color: var(--gray); margin-right: auto;" id="reportsCount">
                    (0 Ú¯Ø²Ø§Ø±Ø´)
                </span>
            </h2>
            
            <div class="report-list" id="reportsList">
                  <!-- Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ -->
        <div class="card">
            <h2 class="section-title">
                <i class="fas fa-chart-bar"></i>
                
            </h2>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ù…Ø¹ÛŒØ§Ø±</th>
                            <th>Ù…Ù‚Ø¯Ø§Ø± ÙØ¹Ù„ÛŒ</th>
                            <th>Ù‡Ø¯Ù</th>
                            <th>Ø§Ù†Ø­Ø±Ø§Ù</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ (Ø³Ø§Ø¹Øª)</td>
                            <td id="avgResponseTime">-</td>
                            <td>4</td>
                            <td class="negative" id="responseDeviation">-</td>
                        </tr>
                        <tr>
                            <td>Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ù…ÙˆÙÙ‚</td>
                            <td id="completionRate">-</td>
                            <td>95%</td>
                            <td class="negative" id="completionDeviation">-</td>
                        </tr>
                        <tr>
                            <td>Ù‡Ø²ÛŒÙ†Ù‡ Ù…ØªÙˆØ³Ø· ØªØ¹Ù…ÛŒØ±Ø§Øª</td>
                            <td id="avgRepairCost">-</td>
                            <td>$1,100</td>
                            <td class="negative" id="costDeviation">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
            </div>
        </div>

      

        <script>
            // ==================== CUSTOM ALERT SYSTEM ====================
            delete window.alert;
        
            window.alert = function(message) {
                return new Promise((resolve) => {
                    const overlay = document.createElement('div');
                    overlay.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    `;
                    
                    const dialog = document.createElement('div');
                    dialog.style.cssText = `
                        background: white;
                        padding: 25px;
                        border-radius: 12px;
                        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                        text-align: center;
                        min-width: 300px;
                        max-width: 90%;
                        font-family: Vazirmatn, sans-serif;
                        border: 2px solid #2c3e50;
                    `;
                    
                    dialog.innerHTML = `
                        <div style="margin-bottom: 20px; font-size: 16px; color: #2c3e50; line-height: 1.5;">${message}</div>
                        <button onclick="closeCustomAlert()" 
                                style="padding: 10px 25px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            ØªØ£ÛŒÛŒØ¯
                        </button>
                    `;
                    
                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);
                    
                    window.closeCustomAlert = function() {
                        document.body.removeChild(overlay);
                        resolve();
                    };
                });
            };
        
            // ==================== REAL-TIME UPDATES ====================
            // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase
            const SUPABASE_URL = 'https://kalykylvjqigqlaprlca.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthbHlreWx2anFpZ3FsYXBybGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI1OTcsImV4cCI6MjA3OTEzODU5N30.S8YtogVrxkqYjkgfkGpy4_mS6mqaNxmsHjxnhyBPwEY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
            let allReports = [];
            let filteredReports = [];
        
            // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
            function formatPersianDateTime(date) {
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return new Intl.DateTimeFormat('fa-IR', options).format(date);
            }
        
            // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡ Ø§Ø² ÙˆØ±ÙˆØ¯
            function getTimeSinceLogin(loginTime) {
                const now = new Date();
                const diff = now - loginTime;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(minutes / 60);
                
                if (hours > 0) {
                    return `${hours} Ø³Ø§Ø¹Øª Ùˆ ${minutes % 60} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„`;
                } else {
                    return `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„`;
                }
            }
        
            // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
            function updateOnlineTime() {
                const loginTimeElement = document.getElementById('loginTime');
                if (loginTimeElement && window.loginTime) {
                    loginTimeElement.textContent = getTimeSinceLogin(window.loginTime);
                }
            }
        
            // ØªÙ†Ø¸ÛŒÙ… Real-time updates
            function setupRealTimeUpdates() {
                window.reportsSubscription = supabase
                    .channel('managerreports-changes')
                    .on(
                        'postgres_changes',
                        {
                            event: '*', // INSERT, UPDATE, DELETE
                            schema: 'public',
                            table: 'managerreports'
                        },
                        (payload) => {
                            console.log('ØªØºÛŒÛŒØ± Real-time Ø¯Ø± Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:', payload);
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
                            showUpdateNotification(payload.eventType);
                            
                            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ù„ÛŒØ³Øª
                            loadManagerReports();
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('âœ… Real-time updates Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Real-time');
                        } else if (status === 'TIMED_OUT') {
                            console.warn('Ø§ØªØµØ§Ù„ Real-time timeout Ø®ÙˆØ±Ø¯');
                            // ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
                            setTimeout(setupRealTimeUpdates, 5000);
                        }
                    });
            }
        
            // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
            function showUpdateNotification(eventType) {
                const messages = {
                    'INSERT': 'ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯',
                    'UPDATE': 'âœï¸ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 
                    'DELETE': 'ğŸ—‘ï¸ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø­Ø°Ù Ø´Ø¯'
                };
                
                const message = messages[eventType] || 'ØªØºÛŒÛŒØ±Ø§ØªÛŒ Ø¯Ø± Ù„ÛŒØ³Øª Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯';
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…ÙˆÙ‚Øª
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 70px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--secondary);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 1001;
                    font-size: 14px;
                    font-weight: 500;
                    animation: slideDown 0.3s ease;
                `;
                
                notification.innerHTML = `
                    <i class="fas fa-sync-alt"></i>
                    ${message}
                `;
                
                document.body.appendChild(notification);
                
                // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }
        
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† animation Ø¨Ø±Ø§ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from {
                        opacity: 0;
                        transform: translateX(-50%) translateY(-20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
        
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯
            document.addEventListener('DOMContentLoaded', function() {
                // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø¨Ø§ Ø­Ø±Ú©Ø§Øª Ú†Ù†Ø¯Ù„Ù…Ø³ÛŒ
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
        
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
        
                document.addEventListener('gesturestart', function(e) {
                    e.preventDefault();
                });
        
                document.addEventListener('gesturechange', function(e) {
                    e.preventDefault();
                });
        
                document.addEventListener('gestureend', function(e) {
                    e.preventDefault();
                });
        
                // Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±
                const now = new Date();
                window.loginTime = now;
                
                // Ù†Ù…Ø§ÛŒØ´ Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯
                const loginTimeElement = document.getElementById('loginTime');
                const lastLoginTimeElement = document.getElementById('lastLoginTime');
                const userNameElement = document.getElementById('userName');
                const userAvatarElement = document.getElementById('userAvatar');
                
                if (loginTimeElement) {
                    loginTimeElement.textContent = formatPersianDateTime(now);
                }
                
                if (lastLoginTimeElement) {
                    lastLoginTimeElement.textContent = formatPersianDateTime(now);
                }
        
                // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
                setInterval(updateOnlineTime, 60000);
        
                // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase Ùˆ Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                loadManagerReports();
                
                // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ÙÛŒÙ„ØªØ±
                document.getElementById('searchInput').addEventListener('input', filterReports);
                document.getElementById('statusFilter').addEventListener('change', filterReports);
                document.getElementById('priorityFilter').addEventListener('change', filterReports);
                
                // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ø§Ù„ Ø¯Ø± Ù†ÙˆÛŒÚ¯ÛŒØ´Ù†
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        navLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
        
                // Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² ØµÙØ­Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
                if (typeof auth !== 'undefined') {
                    if (auth.protectPageByRole('manager')) {
                        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
                        if (userNameElement) {
                            userNameElement.textContent = auth.getUsername() || 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
                        }
                        if (userAvatarElement) {
                            userAvatarElement.textContent = auth.getUsername() ? auth.getUsername().charAt(0) : 'M';
                        }
                    }
                } else {
                    // Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡ - ÙˆÙ‚ØªÛŒ auth.js ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                    console.log('Ø­Ø§Ù„Øª ØªÙˆØ³Ø¹Ù‡: ÙØ§ÛŒÙ„ auth.js ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    if (userNameElement) {
                        userNameElement.textContent = 'Ù…Ø¯ÛŒØ±  (ØªÙˆØ³Ø¹Ù‡)';
                    }
                    if (userAvatarElement) {
                        userAvatarElement.textContent = 'M';
                    }
                }
            });
        
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„ Ù‡Ù†Ú¯Ø§Ù… Ø²ÙˆÙ… Ø¯Ø± iOS
            // document.addEventListener('touchmove', function(e) {
            //     if(e.scale !== 1) {
            //         e.preventDefault();
            //     }
            // }, { passive: false });
        
            // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
            function getStatusText(status) {
                const statusMap = {
                    'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ',
                    'approved': 'ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡',
                    'rejected': 'Ø±Ø¯ Ø´Ø¯Ù‡',
                    'in-progress': 'Ø¯Ø± Ø¯Ø³Øª Ø§Ù‚Ø¯Ø§Ù…',
                    'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                    'referred_to_manager': 'Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ø¯ÛŒØ±'
                };
                return statusMap[status] || status;
            }
        
            function getPriorityText(priority) {
                const priorityMap = {
                    'low': 'Ú©Ù…',
                    'medium': 'Ù…ØªÙˆØ³Ø·',
                    'high': 'Ø¨Ø§Ù„Ø§',
                    'critical': 'Ø¨Ø­Ø±Ø§Ù†ÛŒ'
                };
                return priorityMap[priority] || priority;
            }
        
            function getPriorityColor(priority) {
                const colorMap = {
                    'low': '#2ecc71',
                    'medium': '#f39c12', 
                    'high': '#e74c3c',
                    'critical': '#c0392b'
                };
                return colorMap[priority] || '#3498db';
            }
        
            // Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø§Ø² Ø¬Ø¯ÙˆÙ„ managerreports
            async function loadManagerReports() {
                try {
                    const { data: reports, error } = await supabase
                        .from('managerreports')
                        .select('*')
                        .order('created_at', { ascending: false });
        
                    if (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§:', error);
                        // Ø§Ú¯Ø± Ø¬Ø¯ÙˆÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø§Ø¯Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                        if (error.code === 'PGRST204') {
                            await createSampleData();
                            return;
                        }
                        throw error;
                    }
        
                    allReports = reports || [];
                    filteredReports = [...allReports];
                    
                    updateStats();
                    renderReports();
                    checkCleanupAlert();
                    
                    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Real-time updates (ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø±)
                    if (!window.reportsSubscription) {
                        setupRealTimeUpdates();
                    }
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ:', error);
                    await alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø§Ø² Ø³Ø±ÙˆØ±');
                }
            }
        
            // ØªÙˆÙ‚Ù Real-time updates Ù‡Ù†Ú¯Ø§Ù… Ø®Ø±ÙˆØ¬ Ø§Ø² ØµÙØ­Ù‡
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && window.reportsSubscription) {
                    // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù…Ø®ÙÛŒ Ø´Ø¯ØŒ subscription Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†
                    supabase.removeChannel(window.reportsSubscription);
                    window.reportsSubscription = null;
                } else if (document.visibilityState === 'visible' && !window.reportsSubscription) {
                    // ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ visible Ø´Ø¯ØŒ subscription Ø±Ø§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†
                    setTimeout(loadManagerReports, 1000);
                }
            });
        
            // ØªÙˆÙ‚Ù subscription Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØµÙØ­Ù‡
            window.addEventListener('beforeunload', function() {
                if (window.reportsSubscription) {
                    supabase.removeChannel(window.reportsSubscription);
                }
            });
        
            // Ø¢Ù¾Ø¯ÛŒØª Ø¢Ù…Ø§Ø±
            function updateStats() {
                const totalReports = allReports.length;
                const pendingReports = allReports.filter(r => 
                    !r.status || r.status === 'pending' || r.status === 'in-progress'
                ).length;
                const completedReports = allReports.filter(r => r.status === 'completed').length;
                const referredReports = allReports.filter(r => r.status === 'referred_to_manager').length;
        
                document.getElementById('totalReports').textContent = totalReports;
                document.getElementById('pendingReports').textContent = pendingReports;
                document.getElementById('completedReports').textContent = completedReports;
                document.getElementById('referredReports').textContent = referredReports;
                document.getElementById('reportsCount').textContent = `(${filteredReports.length} Ú¯Ø²Ø§Ø±Ø´)`;
        
                // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
                updatePerformanceMetrics();
            }
        
            // Ø¢Ù¾Ø¯ÛŒØª Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
            function updatePerformanceMetrics() {
                const completedReports = allReports.filter(r => r.status === 'completed');
                
                if (completedReports.length > 0) {
                    // Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ
                    const totalResponseTime = completedReports.reduce((sum, report) => {
                        const createdAt = new Date(report.created_at);
                        const completedAt = new Date(report.completed_at || report.updated_at || report.created_at);
                        const diffHours = (completedAt - createdAt) / (1000 * 60 * 60);
                        return sum + (isNaN(diffHours) ? 0 : diffHours);
                    }, 0);
                    
                    const avgResponseTime = (totalResponseTime / completedReports.length).toFixed(1);
                    document.getElementById('avgResponseTime').textContent = `${avgResponseTime} Ø³Ø§Ø¹Øª`;
                    document.getElementById('responseDeviation').textContent = `${(avgResponseTime - 4).toFixed(1)} Ø³Ø§Ø¹Øª`;
        
                    // Ù†Ø±Ø® ØªÚ©Ù…ÛŒÙ„ Ù…ÙˆÙÙ‚
                    const successfulCompletions = completedReports.filter(r => 
                        !r.decision_status || r.decision_status === 'approved'
                    ).length;
                    const completionRate = ((successfulCompletions / completedReports.length) * 100).toFixed(1);
                    document.getElementById('completionRate').textContent = `${completionRate}%`;
                    document.getElementById('completionDeviation').textContent = `${(completionRate - 95).toFixed(1)}%`;
                } else {
                    document.getElementById('avgResponseTime').textContent = '-';
                    document.getElementById('responseDeviation').textContent = '-';
                    document.getElementById('completionRate').textContent = '-';
                    document.getElementById('completionDeviation').textContent = '-';
                }
                
                document.getElementById('avgRepairCost').textContent = '-';
                document.getElementById('costDeviation').textContent = '-';
            }
        
            // Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´Ø§Øª
            function renderReports() {
                const reportsList = document.getElementById('reportsList');
                
                if (!filteredReports || filteredReports.length === 0) {
                    reportsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                            <h3>Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                            <p>Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯.</p>
                        </div>
                    `;
                    return;
                }
        
                reportsList.innerHTML = filteredReports.map(report => {
                    const status = report.status || 'pending';
                    const priority = report.priority || 'medium';
                    const priorityColor = getPriorityColor(priority);
                    
                    return `
                    <div class="report-item">
                        <div class="report-info">
                            <div class="report-icon" style="background: ${priorityColor}">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="report-content">
                                <div class="report-title">${report.machine_name || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
                                <div class="report-desc">${report.problem_description || 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª'}</div>
                                <div style="display: flex; gap: 10px; margin-top: 6px; font-size: 11px; color: #666; flex-wrap: wrap;">
                                    <span><strong>Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡Ù†Ø¯Ù‡:</strong> ${report.reporter_name || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span>
                                    <span><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> ${getStatusText(status)}</span>
                                    <span><strong>Ø§ÙˆÙ„ÙˆÛŒØª:</strong> ${getPriorityText(priority)}</span>
                                    <span><strong>ØªØ§Ø±ÛŒØ®:</strong> ${new Date(report.created_at).toLocaleDateString('fa-IR')}</span>
                                </div>
                                ${report.manager_message ? `
                                    <div style="margin-top: 6px; padding: 6px; background: #fff3cd; border-radius: 4px; font-size: 11px;">
                                        <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…Ø¯ÛŒØ±:</strong> ${report.manager_message}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="download-btn" onclick="downloadSingleReport('${report.id}')" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§ÛŒÙ† Ú¯Ø²Ø§Ø±Ø´">
                                <i class="fas fa-download"></i>
                                Ø¯Ø§Ù†Ù„ÙˆØ¯
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
            }
        
            // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ú¯Ø²Ø§Ø±Ø´Ø§Øª
            function filterReports() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;
        
                filteredReports = allReports.filter(report => {
                    const matchesSearch = 
                        (report.machine_name && report.machine_name.toLowerCase().includes(searchTerm)) || 
                        (report.problem_description && report.problem_description.toLowerCase().includes(searchTerm)) ||
                        (report.reporter_name && report.reporter_name.toLowerCase().includes(searchTerm));
                    
                    const reportStatus = report.status || 'pending';
                    const matchesStatus = statusFilter === 'all' || reportStatus === statusFilter;
                    
                    const reportPriority = report.priority || 'medium';
                    const matchesPriority = priorityFilter === 'all' || reportPriority === priorityFilter;
                    
                    return matchesSearch && matchesStatus && matchesPriority;
                });
        
                renderReports();
                updateStats();
            }
        
            // Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©â€ŒØ³Ø§Ø²ÛŒ
            function checkCleanupAlert() {
                const now = new Date();
                const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                const daysUntilCleanup = Math.ceil((nextMonth - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilCleanup <= 1) {
                    const alertElement = document.getElementById('cleanupAlert');
                    const messageElement = document.getElementById('cleanupMessage');
                    
                    messageElement.textContent = 
                        `Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§ ${daysUntilCleanup} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø± Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ú©Ø§Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯.`;
                    
                    alertElement.style.display = 'block';
                }
            }
        
            // Ø¨Ø³ØªÙ† Ù‡Ø´Ø¯Ø§Ø±
            function dismissAlert() {
                document.getElementById('cleanupAlert').style.display = 'none';
            }
        
            // Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            async function downloadAllData() {
                await downloadData(allReports, 'Ù‡Ù…Ù‡_Ú¯Ø²Ø§Ø±Ø´Ø§Øª_Ù…Ø¯ÛŒØ±ÛŒØªÛŒ');
            }
        
            // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡
            async function downloadFilteredData() {
                await downloadData(filteredReports, 'Ú¯Ø²Ø§Ø±Ø´Ø§Øª_ÙÛŒÙ„ØªØ±_Ø´Ø¯Ù‡');
            }
        
            // Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒÚ© Ú¯Ø²Ø§Ø±Ø´ Ø®Ø§Øµ
            async function downloadSingleReport(reportId) {
                const report = allReports.find(r => r.id === reportId);
                if (report) {
                    await downloadData([report], `Ú¯Ø²Ø§Ø±Ø´_${report.machine_name || report.id}`);
                }
            }
        
            // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            async function downloadData(data, filename) {
                try {
                    // ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
                    const csvData = convertToCSV(data);
                    // const jsonData = JSON.stringify(data, null, 2);
        
                    // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
                    createDownloadLink(csvData, `${filename}.csv`, 'text/csv');
                    // createDownloadLink(jsonData, `${filename}.json`, 'application/json');
        
                    await alert(`Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯. ÙØ±Ù…Øªâ€ŒÙ‡Ø§ÛŒ CSV  Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÙ†Ø¯.`);
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„:', error);
                    await alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ÛŒ');
                }
            }
        
            // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ CSV
            function convertToCSV(data) {
                if (!data.length) return '';
                
                const headers = Object.keys(data[0]);
                const csvRows = [headers.join(',')];
                
                for (const row of data) {
                    const values = headers.map(header => {
                        const value = row[header];
                        // Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± null/undefined
                        if (value === null || value === undefined) return '';
                        // Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§
                        return typeof value === 'string' ? `"${value.replace(/"/g, '""')}"` : value;
                    });
                    csvRows.push(values.join(','));
                }
                
                return csvRows.join('\n');
            }
        
            // Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯
            function createDownloadLink(data, filename, mimeType) {
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        </script>
</body>
</html>

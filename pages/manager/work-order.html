<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2c3e50">
    <title>TPM PRO - Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±</title>
    <link rel="icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="../../manifest.json">
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }

        html {
            height: 100%;
            overflow: auto;
        }

        body {
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: auto;
            background: #f8f9fa;
            color: var(--dark);
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            -webkit-overflow-scrolling: touch;
        }
        

        :root {
            --primary: #2c3e50;
            --primary-light: #34495e;
            --accent: #e74c3c;
            --accent-light: #ff6b6b;
            --secondary: #3498db;
            --dark: #1a252f;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        /* Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† */
        .navbar {
            background: var(--primary);
            color: white;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            height: 60px;
            flex-shrink: 0;
        }

        .nav-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            background: transparent;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .logo-text {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
        }

        .nav-links {
            display: flex;
            gap: 15px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link.active {
            background: rgba(255,255,255,0.15);
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .login-time {
            font-size: 11px;
            opacity: 0.8;
            color: #ecf0f1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            border: 2px solid rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        /* Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ */
        .main-wrapper {
            height: calc(100vh - 60px);
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px 15px;
            width: 100%;
        }

        .header-card {
            background: var(--primary);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
        }

        .page-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .page-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
            width: 100%;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #2980b9;
        }

        /* Ø¬Ø¯ÙˆÙ„ Ú¯Ø²Ø§Ø±Ø´Ø§Øª */
        .reports-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .reports-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: right;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid #eaeaea;
            font-size: 14px;
        }

        .reports-table td {
            padding: 12px;
            border-bottom: 1px solid #eaeaea;
            font-size: 13px;
        }

        .reports-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-in-progress {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Ù¾Ø§Ù¾Ø§Ù¾â€ŒÙ‡Ø§ */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 15px;
        }

        .popup-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .popup-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--danger);
        }

        /* ÙØ±Ù…â€ŒÙ‡Ø§ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary);
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: #f8f9fa;
            -webkit-appearance: none;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--secondary);
            background: white;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .alert-warning {
            background: #fff8e1;
            border: 1px solid #ffd54f;
            color: #e65100;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        /* ÙÛŒÙ„ØªØ±Ù‡Ø§ */
        .filters-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        /* Ø¢Ù…Ø§Ø± */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            width: 100%;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: 1px solid #eaeaea;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .stat-label {
            color: var(--gray);
            font-size: 12px;
        }

        /* Ø±Ø³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-links span {
                display: none;
            }
            
            .user-details {
                display: none;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .form-actions .btn {
                min-width: 100px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0 10px;
            }
            
            .nav-container {
                height: 50px;
            }
            
            .logo-icon {
                width: 30px;
                height: 30px;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .reports-table {
                display: block;
                overflow-x: auto;
            }
            
            /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù¾Ø§Ù¾Ø§Ù¾â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ iPhone */
            .popup-overlay {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
            
            .popup-content {
                padding: 15px;
                max-height: 85vh;
                width: 95%;
                margin: 0 auto;
            }
            
            .popup-title {
                font-size: 16px;
            }
            
            /* Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… Ø¯Ø± Ù¾Ø§Ù¾Ø§Ù¾ Ø¨Ø±Ø§ÛŒ iPhone */
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .form-actions .btn {
                width: 100%;
                margin: 0;
                padding: 14px 16px;
                font-size: 15px;
                min-height: 46px;
            }
            
            /* Ø¨Ù‡Ø¨ÙˆØ¯ ÙØ±Ù…â€ŒÙ‡Ø§ */
            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .form-input, .form-select, .form-textarea {
                padding: 14px;
                font-size: 16px;
            }
            
            .form-textarea {
                min-height: 100px;
            }
            
            /* Ø¨Ù‡Ø¨ÙˆØ¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ù¾Ø§Ù¾ Ø¬Ø²Ø¦ÛŒØ§Øª */
            #detailsContent .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            #detailsContent .form-actions .btn {
                width: 100%;
                margin: 0;
                justify-content: center;
                padding: 14px;
                min-height: 46px;
            }
        }
        
        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ iPhone Ø¯Ø± Ø­Ø§Ù„Øª Ù„Ù†Ø¯Ø§Ø³Ú©ÛŒÙ¾ */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .popup-overlay {
                padding-top: 10px;
                align-items: flex-start;
            }
            
            .popup-content {
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .form-actions {
                flex-direction: row;
                gap: 8px;
            }
            
            .form-actions .btn {
                padding: 10px 12px;
                font-size: 13px;
                min-height: 44px;
            }
        }
        
        /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø²ÙˆÙ… Ø¯Ø± input fields Ø¯Ø± iOS */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* Ø¨Ù‡Ø¨ÙˆØ¯ Ù„Ù…Ø³ Ø¯Ø± iOS */
        .btn, .form-actions .btn {
            cursor: pointer;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        @supports (padding: max(0px)) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
        }
    </style>
</head>
<body>
    <!-- Ù†ÙˆÛŒÚ¯ÛŒØ´Ù† -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <div class="logo-icon">
                    <img src="../../Logo.png" style="max-block-size:100% ;" >
                </div>
                <div class="logo-text">TPM PRO</div>
            </div>
            
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link ">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</span>
                </a>
                <a href="reports.html" class="nav-link  ">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Ú¯Ø²Ø§Ø±Ø´Ø§Øª Ø¯Ø±ÛŒØ§ÙØªÛŒ</span>
                </a>
                <!-- <a href="warehouse.html" class="nav-link active">
                    <i class="fas fa-warehouse"></i>
                    <span>Ø§Ù†Ø¨Ø§Ø±</span>
                </a> -->
                <a href="work-order.html" class="nav-link active" id="troubleshootingLink">
                    <i class="fas fa-tools"></i>
                    <span>Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±</span>
                </a>
            </div>
            
            <div class="user-info">
                <div class="user-details">
                    <div class="user-name" id="userName">Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…</div>
                    <div class="login-time" id="loginTime">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
                </div>
                <div class="user-avatar" id="userAvatar">M</div>
            </div>
        </div>
    </nav>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="main-wrapper">
        <div class="container" id="mainContainer">
            <!-- Ù‡Ø¯Ø± ØµÙØ­Ù‡ -->
            <div class="header-card">
                <h1 class="page-title">Ø³ÛŒØ³ØªÙ… Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±</h1>
                <p class="page-subtitle">Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ¹Ù…ÛŒØ± Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ùˆ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ ÙˆØ¶Ø¹ÛŒØª</p>
            </div>

            <!-- Ù‡Ø´Ø¯Ø§Ø± Ø³ÛŒØ³ØªÙ… -->
            <div id="systemAlert" style="display: none;"></div>

            <!-- Ø¢Ù…Ø§Ø± Ø³Ø±ÛŒØ¹ -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-number">0</div>
                    <div class="stat-label">Ú©Ù„ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±Ù‡Ø§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: var(--warning);">0</div>
                    <div class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: var(--secondary);">0</div>
                    <div class="stat-label">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: var(--success);">0</div>
                    <div class="stat-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
                </div>
            </div>

            <!-- Ù‡Ø´Ø¯Ø§Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ -->
            <div class="alert alert-warning" id="cleanupAlert" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <strong>ØªÙˆØ¬Ù‡:</strong> ÙØ±Ø¯Ø§ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª. ØªÙ…Ø§Ù… Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù…Ø§Ù‡ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.
                    <button class="btn btn-secondary" onclick="exportData()" style="margin-right: 10px; padding: 4px 12px; font-size: 12px;">
                        <i class="fas fa-download"></i> Ø®Ø±ÙˆØ¬ÛŒ Excel
                    </button>
                </div>
            </div>

            <!-- Ø¨Ø®Ø´ Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯ -->
            <div class="card">
                <div class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
                </div>
                <button class="btn btn-primary" onclick="openWorkOrderPopup()">
                    <i class="fas fa-plus"></i>
                    Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
                </button>
            </div>

            <!-- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´Ø§Øª -->
            <div class="card">
                <div class="section-title">
                    <i class="fas fa-filter"></i>
                    ÙÛŒÙ„ØªØ± Ú¯Ø²Ø§Ø±Ø´Ø§Øª
                </div>
                <div class="filters-container">
                    <div class="filter-group">
                        <label class="form-label">ÙˆØ¶Ø¹ÛŒØª</label>
                        <select class="form-select" id="statusFilter" onchange="filterReports()">
                            <option value="all">Ù‡Ù…Ù‡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§</option>
                            <option value="pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</option>
                            <option value="in-progress">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</option>
                            <option value="completed">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</option>
                            <option value="cancelled">Ù„ØºÙˆ Ø´Ø¯Ù‡</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">Ø§ÙˆÙ„ÙˆÛŒØª</label>
                        <select class="form-select" id="priorityFilter" onchange="filterReports()">
                            <option value="all">Ù‡Ù…Ù‡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§</option>
                            <option value="low">Ú©Ù…</option>
                            <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                            <option value="high">Ø¨Ø§Ù„Ø§</option>
                            <option value="critical">Ø­ÛŒØ§ØªÛŒ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="form-label">ØªØ§Ø±ÛŒØ® Ø§Ø²</label>
                        <input type="date" class="form-input" id="dateFromFilter" onchange="filterReports()">
                    </div>
                    <div class="filter-group">
                        <label class="form-label">ØªØ§Ø±ÛŒØ® ØªØ§</label>
                        <input type="date" class="form-input" id="dateToFilter" onchange="filterReports()">
                    </div>
                </div>
            </div>

            <!-- Ø¬Ø¯ÙˆÙ„ Ú¯Ø²Ø§Ø±Ø´Ø§Øª -->
            <div class="card">
                <div class="section-title">
                    <i class="fas fa-list"></i>
                    Ù„ÛŒØ³Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±Ù‡Ø§
                </div>
                <div style="overflow-x: auto;">
                    <table class="reports-table" id="reportsTable">
                        <thead>
                            <tr>
                                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                                <th>Ø¹Ù†ÙˆØ§Ù† Ù…Ø´Ú©Ù„</th>
                                <th>Ù…Ø³Ø¦ÙˆÙ„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</th>
                                <th>Ø§ÙˆÙ„ÙˆÛŒØª</th>
                                <th>Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª</th>
                                <th>ÙˆØ¶Ø¹ÛŒØª</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--gray); padding: 20px;">
                                    Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div style="text-align: center; margin-top: 15px; color: var(--gray); font-size: 13px;" id="tableInfo">
                    Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...
                </div>
            </div>
        </div>
    </div>

    <!-- Ù¾Ø§Ù¾Ø§Ù¾ Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± -->
    <div class="popup-overlay" id="workOrderPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</h3>
                <button class="close-btn" onclick="closeWorkOrderPopup()">&times;</button>
            </div>
            
            <!-- Ù‡Ø´Ø¯Ø§Ø± ÙØ±Ù… -->
            <div id="formAlert" style="display: none;"></div>
            
            <!-- Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ -->
            <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 10px; color: var(--gray);">Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª...</p>
            </div>
            
            <form id="workOrderForm">
                <div class="form-group">
                    <label class="form-label" for="woTitle">Ø¹Ù†ÙˆØ§Ù† Ù…Ø´Ú©Ù„ *</label>
                    <input type="text" id="woTitle" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø±Ø§Ø¨ÛŒ Ù…ÙˆØªÙˆØ± Ø¯Ø³ØªÚ¯Ø§Ù‡" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="woAssignedTo">Ù…Ø³Ø¦ÙˆÙ„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ *</label>
                        <select id="woAssignedTo" class="form-select" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø³Ø¦ÙˆÙ„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</option>
                            <option value="Ù†ÙˆØ±ÙˆØ²ÛŒ">Ù†ÙˆØ±ÙˆØ²ÛŒ</option>
                            <option value="Ù…Ø­Ù…Ø¯ÛŒ">Ù…Ø­Ù…Ø¯ÛŒ</option>
                            <option value="Ø³Ø§ÛŒØ±">Ø³Ø§ÛŒØ±</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="woPriority">Ø§ÙˆÙ„ÙˆÛŒØª *</label>
                        <select id="woPriority" class="form-select" required>
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§ÙˆÙ„ÙˆÛŒØª</option>
                            <option value="low">Ú©Ù…</option>
                            <option value="medium">Ù…ØªÙˆØ³Ø·</option>
                            <option value="high">Ø¨Ø§Ù„Ø§</option>
                            <option value="critical">Ø­ÛŒØ§ØªÛŒ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="woRequestType">Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª *</label>
                    <select id="woRequestType" class="form-select" required>
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹</option>
                        <option value="supervisor">ØªÙˆØ³Ø· Ø³Ø±Ù¾Ø±Ø³Øª</option>
                        <option value="operator">ØªÙˆØ³Ø· Ø§Ù¾Ø±Ø§ØªÙˆØ±</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="woDescription">Ø´Ø±Ø­ Ù…Ø´Ú©Ù„ *</label>
                    <textarea id="woDescription" class="form-textarea" placeholder="Ø´Ø±Ø­ Ú©Ø§Ù…Ù„ Ù…Ø´Ú©Ù„ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." required></textarea>
                    <div style="text-align: left; font-size: 12px; color: var(--gray); margin-top: 5px;">
                        <span id="charCount">0</span>/500 Ú©Ø§Ø±Ø§Ú©ØªØ±
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="woNotes">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
                    <textarea id="woNotes" class="form-textarea" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeWorkOrderPopup()">
                        <i class="fas fa-times"></i> Ø§Ù†ØµØ±Ø§Ù
                    </button>
                    <button type="submit" class="btn btn-primary" style="margin-bottom: 25px;">
                        <i class="fas fa-save"></i> Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±
                    </button>
                </div>
            </form>
            
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </div>
    </div>

    <!-- Ù¾Ø§Ù¾Ø§Ù¾ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± -->
    <div class="popup-overlay" id="detailsPopup">
        <div class="popup-content">
            <div class="popup-header">
                <h3 class="popup-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±</h3>
                <button class="close-btn" onclick="closeDetailsPopup()">&times;</button>
            </div>
            
            <div id="detailsContent">
                <!-- Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>
        </div>
    </div>

    <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øªâ€ŒÙ‡Ø§ -->
    <script>
       // Ø­Ø°Ù alert Ùˆ confirm Ø§ØµÙ„ÛŒ
       delete window.alert;
        delete window.confirm;

        // Ø³Ø§Ø®Øª alert Ú©Ø§Ø³ØªÙˆÙ… Ø¨Ø§ ØªÙˆÙ‚Ù Ú©Ø§Ù…Ù„
        window.alert = function(message) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    padding: 25px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                    text-align: center;
                    min-width: 300px;
                    max-width: 90%;
                    font-family: Vazirmatn, sans-serif;
                    border: 2px solid #2c3e50;
                `;
                
                dialog.innerHTML = `
                    <div style="margin-bottom: 20px; font-size: 16px; color: #2c3e50; line-height: 1.5;">${message}</div>
                    <button onclick="closeCustomAlert()" 
                            style="padding: 10px 25px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        ØªØ£ÛŒÛŒØ¯
                    </button>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                window.closeCustomAlert = function() {
                    document.body.removeChild(overlay);
                    resolve();
                };
            });
        };

        // Ø³Ø§Ø®Øª confirm Ú©Ø§Ø³ØªÙˆÙ… Ø¨Ø§ ØªÙˆÙ‚Ù Ú©Ø§Ù…Ù„
        window.confirm = function(message) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: white;
                    padding: 25px;
                    border-radius: 12px;
                    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                    text-align: center;
                    min-width: 300px;
                    max-width: 90%;
                    font-family: Vazirmatn, sans-serif;
                    border: 2px solid #2c3e50;
                `;
                
                dialog.innerHTML = `
                    <div style="margin-bottom: 20px; font-size: 16px; color: #2c3e50; line-height: 1.5;">${message}</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="closeCustomConfirm(true)" 
                                style="padding: 10px 25px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Ø¨Ù„Ù‡
                        </button>
                        <button onclick="closeCustomConfirm(false)" 
                                style="padding: 10px 25px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            Ø®ÛŒØ±
                        </button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                window.closeCustomConfirm = function(result) {
                    document.body.removeChild(overlay);
                    resolve(result);
                };
            });
        };

       
       // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://kalykylvjqigqlaprlca.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthbHlreWx2anFpZ3FsYXBybGNhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI1OTcsImV4cCI6MjA3OTEzODU5N30.S8YtogVrxkqYjkgfkGpy4_mS6mqaNxmsHjxnhyBPwEY';
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('Supabase initialized');

        // ==================== GLOBAL VARIABLES ====================
        const priorityLabels = {
            'low': 'Ú©Ù…',
            'medium': 'Ù…ØªÙˆØ³Ø·',
            'high': 'Ø¨Ø§Ù„Ø§',
            'critical': 'Ø­ÛŒØ§ØªÛŒ'
        };
        
        const priorityColors = {
            'low': '#27ae60',
            'medium': '#f39c12',
            'high': '#e74c3c',
            'critical': '#c0392b'
        };
        
        const statusLabels = {
            'pending': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
            'in-progress': 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…',
            'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
            'cancelled': 'Ù„ØºÙˆ Ø´Ø¯Ù‡'
        };
        
        const requestTypeLabels = {
            'supervisor': 'ØªÙˆØ³Ø· Ø³Ø±Ù¾Ø±Ø³Øª',
            'operator': 'ØªÙˆØ³Ø· Ø§Ù¾Ø±Ø§ØªÙˆØ±'
        };

        let allWorkOrders = []; // Ú©Ø´ Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        let filterTimeout;

        // ==================== HELPER FUNCTIONS ====================
        function showAlert(containerId, type, message, autoClose = false) {
            const container = document.getElementById(containerId);
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${getAlertIcon(type)}"></i>
                <div style="flex: 1;">${message}</div>
                <button onclick="this.parentElement.remove()" 
                        style="background: none; border: none; color: inherit; cursor: pointer; padding: 0 5px;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            container.style.display = 'block';
            
            if (autoClose) {
                setTimeout(() => {
                    if (alertDiv.parentElement === container) {
                        container.style.display = 'none';
                    }
                }, 5000);
            }
        }
        
        function getAlertIcon(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }
        
        function formatPersianDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function updateCharCount() {
            const textarea = document.getElementById('woDescription');
            const charCount = document.getElementById('charCount');
            const count = textarea.value.length;
            charCount.textContent = count;
            
            if (count > 450) {
                charCount.style.color = 'var(--danger)';
            } else if (count > 400) {
                charCount.style.color = 'var(--warning)';
            } else {
                charCount.style.color = 'var(--gray)';
            }
        }

        // ==================== REAL-TIME FUNCTIONS ====================
        async function setupRealtimeSubscription() {
            try {
                console.log('Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Real-time...');
                
                // Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÙˆÙ„ work_orders
                const subscription = supabase
                    .channel('work_orders_channel')
                    .on(
                        'postgres_changes',
                        {
                            event: '*',
                            schema: 'public',
                            table: 'work_orders'
                        },
                        async (payload) => {
                            console.log('ØªØºÛŒÛŒØ± Real-time Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:', payload);
                            
                            // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø´ Ù…Ø­Ù„ÛŒ
                            handleRealtimeUpdate(payload);
                            
                            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ù„Ø§Ù†
                            let message = '';
                            let type = 'info';
                            
                            switch(payload.eventType) {
                                case 'INSERT':
                                    message = 'ğŸ“ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯';
                                    type = 'success';
                                    break;
                                case 'UPDATE':
                                    message = 'ğŸ”„ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯';
                                    type = 'warning';
                                    break;
                                case 'DELETE':
                                    message = 'ğŸ—‘ï¸ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø­Ø°Ù Ø´Ø¯';
                                    type = 'danger';
                                    break;
                            }
                            
                            if (message) {
                                showAlert('systemAlert', type, message, true);
                            }
                            
                            // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø§Ø² Ø³Ø±ÙˆØ±
                            updateUIFromCache();
                        }
                    )
                    .subscribe((status) => {
                        console.log('ÙˆØ¶Ø¹ÛŒØª Real-time:', status);
                        
                        if (status === 'SUBSCRIBED') {
                            console.log('âœ… Real-time ÙØ¹Ø§Ù„ Ø´Ø¯');
                            showAlert('systemAlert', 'success', 'Ø³ÛŒØ³ØªÙ… Real-time ÙØ¹Ø§Ù„ Ø´Ø¯ - ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯', true);
                        }
                        
                        if (status === 'CHANNEL_ERROR') {
                            console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Real-time');
                            showAlert('systemAlert', 'warning', 'Ø§ØªØµØ§Ù„ Real-time Ù‚Ø·Ø¹ Ø´Ø¯', true);
                        }
                    });
                
                window.supabaseSubscription = subscription;
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Real-time:', error);
                showAlert('systemAlert', 'warning', 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Real-time', true);
            }
        }
        
        function handleRealtimeUpdate(payload) {
            switch(payload.eventType) {
                case 'INSERT':
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù„ÛŒØ³Øª
                    allWorkOrders.unshift(payload.new);
                    break;
                    
                case 'UPDATE':
                    // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢ÛŒØªÙ… Ù…ÙˆØ¬ÙˆØ¯
                    const updateIndex = allWorkOrders.findIndex(item => item.id === payload.new.id);
                    if (updateIndex !== -1) {
                        allWorkOrders[updateIndex] = payload.new;
                    } else {
                        // Ø§Ú¯Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                        allWorkOrders.unshift(payload.new);
                    }
                    break;
                    
                case 'DELETE':
                    // Ø­Ø°Ù Ø§Ø² Ù„ÛŒØ³Øª
                    allWorkOrders = allWorkOrders.filter(item => item.id !== payload.old.id);
                    break;
            }
        }
        
        function updateUIFromCache() {
            const filters = {
                status: document.getElementById('statusFilter').value,
                priority: document.getElementById('priorityFilter').value,
                dateFrom: document.getElementById('dateFromFilter').value,
                dateTo: document.getElementById('dateToFilter').value
            };
            
            const filteredData = filterWorkOrders(allWorkOrders, filters);
            updateReportsTable(filteredData);
            
            const stats = calculateStatsFromData(filteredData);
            updateStats(stats);
        }
        
        function filterWorkOrders(workOrders, filters) {
            return workOrders.filter(wo => {
                if (filters.status && filters.status !== 'all' && wo.status !== filters.status) {
                    return false;
                }
                
                if (filters.priority && filters.priority !== 'all' && wo.priority !== filters.priority) {
                    return false;
                }
                
                if (filters.dateFrom) {
                    const woDate = new Date(wo.created_at).toISOString().split('T')[0];
                    if (woDate < filters.dateFrom) return false;
                }
                
                if (filters.dateTo) {
                    const woDate = new Date(wo.created_at).toISOString().split('T')[0];
                    if (woDate > filters.dateTo) return false;
                }
                
                return true;
            });
        }
        
        function calculateStatsFromData(workOrders) {
            return {
                total: workOrders.length,
                pending: workOrders.filter(d => d.status === 'pending').length,
                inProgress: workOrders.filter(d => d.status === 'in-progress').length,
                completed: workOrders.filter(d => d.status === 'completed').length,
                cancelled: workOrders.filter(d => d.status === 'cancelled').length
            };
        }
        
        function unsubscribeRealtime() {
            if (window.supabaseSubscription) {
                supabase.removeChannel(window.supabaseSubscription);
                console.log('Ø§ØªØµØ§Ù„ Real-time Ù‚Ø·Ø¹ Ø´Ø¯');
            }
        }

        // ==================== SUPABASE FUNCTIONS ====================
        async function createWorkOrder(workOrderData) {
            try {
                const dataToInsert = {
                    problem_title: workOrderData.problemTitle,
                    assigned_to: workOrderData.assignedTo,
                    priority: workOrderData.priority,
                    problem_description: workOrderData.problemDescription,
                    request_type: workOrderData.requestType,
                    notes: workOrderData.notes || null,
                    status: 'pending'
                };
                
                console.log('Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡ Supabase:', dataToInsert);
                
                const { data, error } = await supabase
                    .from('work_orders')
                    .insert([dataToInsert])
                    .select();
                
                if (error) throw error;
                
                console.log('Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø«Ø¨Øª Ø´Ø¯:', data[0]);
                return {
                    success: true,
                    data: data[0],
                    message: 'Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯'
                };
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±:', error);
                return {
                    success: false,
                    message: error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±'
                };
            }
        }
        
        async function updateWorkOrder(workOrderId, workOrderData) {
            try {
                const dataToUpdate = {
                    problem_title: workOrderData.problemTitle,
                    assigned_to: workOrderData.assignedTo,
                    priority: workOrderData.priority,
                    problem_description: workOrderData.problemDescription,
                    request_type: workOrderData.requestType,
                    notes: workOrderData.notes || null,
                    updated_at: new Date().toISOString()
                };
                
                console.log('Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Supabase:', dataToUpdate);
                
                const { data, error } = await supabase
                    .from('work_orders')
                    .update(dataToUpdate)
                    .eq('id', workOrderId)
                    .select();
                
                if (error) throw error;
                
                console.log('Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯:', data[0]);
                return {
                    success: true,
                    data: data[0],
                    message: 'Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'
                };
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±:', error);
                return {
                    success: false,
                    message: error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±'
                };
            }
        }
        
        async function getAllWorkOrders(filters = {}) {
            try {
                let query = supabase
                    .from('work_orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (filters.status && filters.status !== 'all') {
                    query = query.eq('status', filters.status);
                }
                
                if (filters.priority && filters.priority !== 'all') {
                    query = query.eq('priority', filters.priority);
                }
                
                if (filters.dateFrom) {
                    query = query.gte('created_at', filters.dateFrom + 'T00:00:00');
                }
                
                if (filters.dateTo) {
                    query = query.lte('created_at', filters.dateTo + 'T23:59:59');
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ú©Ø´ Ø¬Ù‡Ø§Ù†ÛŒ
                allWorkOrders = data;
                
                return data;
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±Ù‡Ø§:', error);
                throw error;
            }
        }
        
        async function getWorkOrderStats() {
            try {
                const { data, error } = await supabase
                    .from('work_orders')
                    .select('status');
                
                if (error) throw error;
                
                const stats = {
                    total: data.length,
                    pending: data.filter(d => d.status === 'pending').length,
                    inProgress: data.filter(d => d.status === 'in-progress').length,
                    completed: data.filter(d => d.status === 'completed').length,
                    cancelled: data.filter(d => d.status === 'cancelled').length
                };
                
                return stats;
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±:', error);
                return {
                    total: 0,
                    pending: 0,
                    inProgress: 0,
                    completed: 0,
                    cancelled: 0
                };
            }
        }
        
        async function updateWorkOrderStatus(id, status, notes = '') {
            try {
                const updates = {
                    status: status,
                    updated_at: new Date().toISOString()
                };
                
                if (status === 'completed') {
                    updates.completed_at = new Date().toISOString();
                }
                
                if (notes) {
                    updates.notes = (updates.notes || '') + '\n' + notes;
                }
                
                const { data, error } = await supabase
                    .from('work_orders')
                    .update(updates)
                    .eq('id', id)
                    .select();
                
                if (error) throw error;
                return { success: true, data: data[0] };
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª:', error);
                return { success: false, message: error.message };
            }
        }
        
        async function deleteWorkOrderFromSupabase(id) {
            try {
                const { error } = await supabase
                    .from('work_orders')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                return { success: true };
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±:', error);
                return { success: false, message: error.message };
            }
        }

        // ==================== UI FUNCTIONS ====================
        function openWorkOrderPopup() {
            resetWorkOrderPopup();
            document.getElementById('workOrderPopup').style.display = 'flex';
            document.getElementById('woTitle').focus();
            document.getElementById('formAlert').style.display = 'none';
        }
        
        function closeWorkOrderPopup() {
            document.getElementById('workOrderPopup').style.display = 'none';
            document.getElementById('workOrderForm').reset();
            document.getElementById('formAlert').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('workOrderForm').style.display = 'block';
            resetWorkOrderPopup();
        }
        
        function resetWorkOrderPopup() {
            document.getElementById('workOrderPopup').dataset.editingId = '';
            document.querySelector('#workOrderPopup .popup-title').textContent = 'Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯';
            
            const submitBtn = document.querySelector('#workOrderForm button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±';
            delete submitBtn.dataset.editing;
        }
        
        async function editWorkOrderUI(workOrder) {
            // Ø¨Ø³ØªÙ† Ù¾Ø§Ù¾Ø§Ù¾ Ø¬Ø²Ø¦ÛŒØ§Øª
            closeDetailsPopup();
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø§Ù¾Ø§Ù¾ ÙˆÛŒØ±Ø§ÛŒØ´
            openEditWorkOrderPopup(workOrder);
        }
        
        function openEditWorkOrderPopup(workOrder) {
            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
            document.getElementById('woTitle').value = workOrder.problem_title;
            document.getElementById('woAssignedTo').value = workOrder.assigned_to;
            document.getElementById('woPriority').value = workOrder.priority;
            document.getElementById('woRequestType').value = workOrder.request_type;
            document.getElementById('woDescription').value = workOrder.problem_description;
            document.getElementById('woNotes').value = workOrder.notes || '';
            
            // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±
            updateCharCount();
            
            // ØªØºÛŒÛŒØ± Ø¹Ù†ÙˆØ§Ù† Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ±Ù…
            
            
            // Ø°Ø®ÛŒØ±Ù‡ ID Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„
            document.getElementById('workOrderPopup').dataset.editingId = workOrder.id;
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ù¾Ø§Ù¾
            document.getElementById('workOrderPopup').style.display = 'flex';
            document.getElementById('woTitle').focus();
            document.getElementById('formAlert').style.display = 'none';
            
            // ØªØºÛŒÛŒØ± Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø«Ø¨Øª
           
        }
        
        function openDetailsPopup(workOrder) {
            const detailsContent = document.getElementById('detailsContent');
            
            detailsContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <strong>Ø´Ù†Ø§Ø³Ù‡:</strong> ${workOrder.id}
                            </div>
                            <div>
                                <span class="status-badge status-${workOrder.status}" 
                                      style="background: ${workOrder.status === 'pending' ? '#fff3cd' : 
                                                         workOrder.status === 'in-progress' ? '#d1ecf1' : 
                                                         workOrder.status === 'completed' ? '#d4edda' : '#f8d7da'}; 
                                            color: ${workOrder.status === 'pending' ? '#856404' : 
                                                    workOrder.status === 'in-progress' ? '#0c5460' : 
                                                    workOrder.status === 'completed' ? '#155724' : '#721c24'};">
                                    ${statusLabels[workOrder.status]}
                                </span>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--primary); margin-bottom: 10px;">${workOrder.problem_title}</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <div>
                                <strong>Ù…Ø³Ø¦ÙˆÙ„ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ:</strong><br>
                                ${workOrder.assigned_to}
                            </div>
                            <div>
                                <strong>Ø§ÙˆÙ„ÙˆÛŒØª:</strong><br>
                                <span style="color: ${priorityColors[workOrder.priority]}; font-weight: bold;">
                                    ${priorityLabels[workOrder.priority]}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong>Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:</strong><br>
                            ${requestTypeLabels[workOrder.request_type]}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Ø´Ø±Ø­ Ù…Ø´Ú©Ù„:</strong>
                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #eaeaea; margin-top: 5px;">
                            ${workOrder.problem_description}
                        </div>
                    </div>
                    
                    ${workOrder.notes ? `
                    <div style="margin-bottom: 15px;">
                        <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§:</strong>
                        <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #eaeaea; margin-top: 5px;">
                            ${workOrder.notes}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 12px; color: var(--gray);">
                        <div>
                            <strong>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª:</strong><br>
                            ${formatPersianDate(workOrder.created_at)}
                        </div>
                        ${workOrder.completed_at ? `
                        <div>
                            <strong>ØªØ§Ø±ÛŒØ® ØªÚ©Ù…ÛŒÙ„:</strong><br>
                            ${formatPersianDate(workOrder.completed_at)}
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="form-actions">
                  
                    
                    <button type="button" class="btn btn-primary" onclick="deleteWorkOrderUI(${workOrder.id})">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                    </button>
                </div>
            `;
            
            document.getElementById('detailsPopup').style.display = 'flex';
        }
        
        function closeDetailsPopup() {
            document.getElementById('detailsPopup').style.display = 'none';
        }
        
        async function changeStatus(workOrderId, newStatus) {
            const confirmed = await confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ');
            if (confirmed) {
                const result = await updateWorkOrderStatus(workOrderId, newStatus);
                if (result.success) {
                    // ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Real-time Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    closeDetailsPopup();
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ù„Ø§Ù† Ø³ÛŒØ³ØªÙ…
                    const statusText = statusLabels[newStatus];
                    showAlert('systemAlert', 'success', 
                        `ÙˆØ¶Ø¹ÛŒØª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ù‡ "${statusText}" ØªØºÛŒÛŒØ± ÛŒØ§ÙØª`, 
                        true);
                } else {
                    showAlert('systemAlert', 'danger', result.message, true);
                }
            }
        }
        
        async function deleteWorkOrderUI(workOrderId) {
            const confirmed = await confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ');
            if (confirmed) {
                const result = await deleteWorkOrderFromSupabase(workOrderId);
                if (result.success) {
                    // Ø­Ø°Ù Ø¯Ø± Real-time Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    closeDetailsPopup();
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹Ù„Ø§Ù† Ø³ÛŒØ³ØªÙ…
                    showAlert('systemAlert', 'success', 'Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', true);
                } else {
                    showAlert('systemAlert', 'danger', result.message, true);
                }
            }
        }
        
        async function loadReports(forceReload = false) {
            try {
                const filters = {
                    status: document.getElementById('statusFilter').value,
                    priority: document.getElementById('priorityFilter').value,
                    dateFrom: document.getElementById('dateFromFilter').value,
                    dateTo: document.getElementById('dateToFilter').value
                };
                
                // Ø§Ú¯Ø± forceReload true Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ú©Ø´ Ù†ÛŒØ³ØªØŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ú¯ÛŒØ±
                if (forceReload || allWorkOrders.length === 0) {
                    const workOrders = await getAllWorkOrders(filters);
                    const filteredData = filterWorkOrders(workOrders, filters);
                    updateReportsTable(filteredData);
                    
                    const stats = calculateStatsFromData(filteredData);
                    updateStats(stats);
                } else {
                    // Ø§Ø² Ú©Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
                    const filteredData = filterWorkOrders(allWorkOrders, filters);
                    updateReportsTable(filteredData);
                    
                    const stats = calculateStatsFromData(filteredData);
                    updateStats(stats);
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´Ø§Øª:', error);
                document.getElementById('reportsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--danger); padding: 20px;">
                            Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
                        </td>
                    </tr>
                `;
                document.getElementById('tableInfo').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
                showAlert('systemAlert', 'danger', 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', true);
            }
        }
        
        function updateReportsTable(workOrders) {
            const tbody = document.getElementById('reportsTableBody');
            
            if (workOrders.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: var(--gray); padding: 20px;">
                            Ù‡ÛŒÚ† Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯
                        </td>
                    </tr>
                `;
                document.getElementById('tableInfo').textContent = 'Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯';
                return;
            }
            
            let html = '';
            workOrders.forEach(wo => {
                html += `
                    <tr>
                        <td>${wo.id}</td>
                        <td><strong>${wo.problem_title}</strong></td>
                        <td>${wo.assigned_to}</td>
                        <td>
                            <span style="color: ${priorityColors[wo.priority]}; font-weight: bold;">
                                ${priorityLabels[wo.priority]}
                            </span>
                        </td>
                        <td>${requestTypeLabels[wo.request_type]}</td>
                        <td>${formatPersianDate(wo.created_at)}</td>
                        <td>
                            <span class="status-badge status-${wo.status}" 
                                  style="background: ${wo.status === 'pending' ? '#fff3cd' : 
                                                     wo.status === 'in-progress' ? '#d1ecf1' : 
                                                     wo.status === 'completed' ? '#d4edda' : '#f8d7da'}; 
                                        color: ${wo.status === 'pending' ? '#856404' : 
                                                wo.status === 'in-progress' ? '#0c5460' : 
                                                wo.status === 'completed' ? '#155724' : '#721c24'};">
                                ${statusLabels[wo.status]}
                            </span>
                        </td>
                        <td>
                            <button onclick="openDetailsPopup(${JSON.stringify(wo).replace(/"/g, '&quot;')})" 
                                    style="background: var(--secondary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-eye"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            document.getElementById('tableInfo').textContent = `ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${workOrders.length}`;
        }
        
        function updateStats(stats) {
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Ú©Ù„ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±Ù‡Ø§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: var(--warning);">${stats.pending}</div>
                    <div class="stat-label">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: var(--secondary);">${stats.inProgress}</div>
                    <div class="stat-label">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: var(--success);">${stats.completed}</div>
                    <div class="stat-label">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
                </div>
            `;
        }
        
        function filterReports() {
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² debouncing Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ§Ø¯
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                loadReports(false); // false ÛŒØ¹Ù†ÛŒ Ø§Ø² Ú©Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
            }, 300);
        }
        
        function exportData() {
            showAlert('systemAlert', 'info', 'Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª', true);
        }
        
        function checkEndOfMonth() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (tomorrow.getDate() === 1) {
                document.getElementById('cleanupAlert').style.display = 'flex';
                showAlert('systemAlert', 'warning', 'ÙØ±Ø¯Ø§ Ø§ÙˆÙ„ÛŒÙ† Ø±ÙˆØ² Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ú¯ÛŒØ±ÛŒØ¯.', false);
            }
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±
            const userNameElement = document.getElementById('userName');
            const userAvatarElement = document.getElementById('userAvatar');
            const loginTimeElement = document.getElementById('loginTime');
            
            const now = new Date();
            if (loginTimeElement) {
                loginTimeElement.textContent = now.toLocaleTimeString('fa-IR');
            }
            
            if (userNameElement) {
                userNameElement.textContent = 'Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…';
            }
            if (userAvatarElement) {
                userAvatarElement.textContent = 'M';
            }
            
            // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¯Ø± ÙÛŒÙ„ØªØ±Ù‡Ø§
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFromFilter').value = today;
            document.getElementById('dateToFilter').value = today;
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            try {
                await loadReports(true); // true Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² Ø³Ø±ÙˆØ±
                checkEndOfMonth();
                showAlert('systemAlert', 'success', 'Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯', true);
            } catch (error) {
                showAlert('systemAlert', 'danger', 'Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±', true);
            }
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Real-time
            await setupRealtimeSubscription();
            
            // Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù… Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±
            document.getElementById('workOrderForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.querySelector('#workOrderForm button[type="submit"]');
                const isEditing = submitBtn.dataset.editing === 'true';
                const workOrderId = document.getElementById('workOrderPopup').dataset.editingId;
                
                const title = document.getElementById('woTitle').value.trim();
                const assignedTo = document.getElementById('woAssignedTo').value;
                const priority = document.getElementById('woPriority').value;
                const requestType = document.getElementById('woRequestType').value;
                const description = document.getElementById('woDescription').value.trim();
                
                // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
                if (!title || !assignedTo || !priority || !requestType || !description) {
                    showAlert('formAlert', 'danger', 'Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                if (description.length < 10) {
                    showAlert('formAlert', 'danger', 'Ø´Ø±Ø­ Ù…Ø´Ú©Ù„ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û±Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯');
                    return;
                }
                
                const workOrderData = {
                    problemTitle: title,
                    assignedTo: assignedTo,
                    priority: priority,
                    requestType: requestType,
                    problemDescription: description,
                    notes: document.getElementById('woNotes').value.trim() || null
                };
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('workOrderForm').style.display = 'none';
                
                try {
                    let result;
                    
                    if (isEditing && workOrderId) {
                        // ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯
                        result = await updateWorkOrder(workOrderId, workOrderData);
                    } else {
                        // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
                        result = await createWorkOrder(workOrderData);
                    }
                    
                    if (result.success) {
                        const actionText = isEditing ? 'Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ' : 'Ø«Ø¨Øª';
                        showAlert('formAlert', 'success', `
                            âœ… Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ${actionText} Ø´Ø¯<br>
                            <small>Ø´Ù†Ø§Ø³Ù‡: ${result.data.id}</small>
                        `);
                        
                        setTimeout(() => {
                            closeWorkOrderPopup();
                            resetWorkOrderPopup();
                            // Ø§Ø¹Ù„Ø§Ù† Ø³ÛŒØ³ØªÙ…
                            showAlert('systemAlert', 'success', 
                                isEditing ? 'ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯' : 'Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ø´Ø¯', 
                                true);
                        }, 2000);
                    } else {
                        showAlert('formAlert', 'danger', result.message);
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('workOrderForm').style.display = 'block';
                    }
                } catch (error) {
                    showAlert('formAlert', 'danger', 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¯Ø³ØªÙˆØ±Ú©Ø§Ø±: ' + error.message);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('workOrderForm').style.display = 'block';
                }
            });
            
            // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±
            document.getElementById('woDescription').addEventListener('input', updateCharCount);
            
            // Ø¨Ø³ØªÙ† Ù¾Ø§Ù¾Ø§Ù¾â€ŒÙ‡Ø§
            document.getElementById('workOrderPopup').addEventListener('click', function(e) {
                if (e.target === this) closeWorkOrderPopup();
            });
            
            document.getElementById('detailsPopup').addEventListener('click', function(e) {
                if (e.target === this) closeDetailsPopup();
            });
            
            // Ú©Ù„ÛŒØ¯ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeWorkOrderPopup();
                    closeDetailsPopup();
                }
            });
            
            // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²
                    loadReports(true);
                }
            });
            
            // Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Real-time Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø³ØªÙ† ØµÙØ­Ù‡
            window.addEventListener('beforeunload', unsubscribeRealtime);
            
            console.log('âœ… Ø³ÛŒØ³ØªÙ… Real-time Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
        });
    </script>
</body>
</html>
